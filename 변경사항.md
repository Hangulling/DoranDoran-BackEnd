## DoranDoran 스키마 확장/변경 내역 (컬럼 단위 사유 정리)

**Multi-Agent AI 아키텍처 도입**: 외국인 사용자의 한국어 학습을 지원하는 Multi-Agent 시스템으로 확장하여 친밀도 분석, 어휘 추출, 번역, 대화 Agent를 병렬 처리합니다.

---

### 0) Multi-Agent AI 아키텍처 도입 (신규)

#### 0.1 chatbots.intimacy_level 변경
- **기존**: `intimacy_level integer DEFAULT 0 CHECK (intimacy_level >= 0 AND intimacy_level <= 100)`
- **변경**: `intimacy_level integer DEFAULT 1 CHECK (intimacy_level >= 1 AND intimacy_level <= 3)`
- **사유**: 
  - 외국인 학습자에게 0-100 스케일은 불필요하게 복잡
  - 1-3 단계로 단순화: 1=격식체, 2=부드러운 존댓말, 3=반말
  - 학습 진척도 측정 및 피드백 제공이 용이

#### 0.2 intimacy_progress 테이블 추가 (신규)
- **테이블**: `chat_schema.intimacy_progress`
- **목적**: 채팅방별 친밀도 진척 추적
- **주요 컬럼**:
  - `intimacy_level INT(1~3)`: 현재 친밀도 레벨
  - `total_corrections INT`: 누적 교정 횟수
  - `last_feedback TEXT`: 마지막 피드백 메시지
  - `progress_data JSONB`: 세부 학습 통계
- **사유**: 
  - Multi-Agent AI의 IntimacyAgent 분석 결과 저장
  - 학습 진척도 측정 및 개인화된 피드백 제공
  - 채팅방별 유니크 제약으로 일관된 진척도 추적

#### 0.3 messages.content_type 확장
- **기존**: `content_type VARCHAR(20) DEFAULT 'text' CHECK (content_type IN ('text', 'code', 'system'))`
- **변경**: `content_type VARCHAR(20) DEFAULT 'text' CHECK (content_type IN ('text', 'code', 'system', 'json'))`
- **사유**: Multi-Agent 결과를 JSON 형식으로 저장하여 구조화된 데이터 보존

#### 0.4 Multi-Agent 서비스 구조
- **IntimacyAgent**: 한국어 친밀도 분석 및 교정
- **VocabularyAgent**: 어려운 단어 추출 (최대 1개)
- **TranslationAgent**: 영어 번역 및 발음기호 제공
- **ConversationAgent**: 자연스러운 대화 응답 생성
- **MultiAgentOrchestrator**: 병렬+순차 처리 조율
- **GreetingService**: AI 인사말 자동 발송

#### 0.5 SSE 이벤트 타입 확장
- `intimacy_analysis`: 친밀도 분석 결과
- `vocabulary_extracted`: 어휘 추출 결과
- `vocabulary_translated`: 번역 결과
- `conversation_chunk`: 대화 응답 스트림
- `conversation_complete`: 대화 완료
- `aggregated_complete`: 전체 결과 집계

---

### 1) 사용자 도메인: `doran_user` → `user_schema.app_user` (+ `user_schema.profiles`, `user_schema.settings`)

- 매핑 개요
  - 기존 `doran_user.user_id` → `user_schema.app_user.id`
  - 기존 필드 분리/정규화: 프로필/설정은 각각 `profiles`, `settings`로 분리

- 컬럼 변경/추가 사유
  - `user_id (UUID(10))` → `id (UUID)`
    - 사유: PostgreSQL `UUID` 표준 사용(길이 지정 제거). 마이크로서비스 간 참조 일관성 확보
  - `email (varchar(50))` → `email (varchar(320))`
    - 사유: RFC 표준 호환(국제 도메인 포함). 중복 방지 인덱스 유지
  - `name (varchar(50))` + `first_name/last_name`
    - 사유: 표시용 전체 이름(`name`) 유지 + 서양식/검색 최적화를 위한 분리 필드 유지
  - `password (varchar)` → `password_hash (varchar(100))`
    - 사유: 보안 강화를 위한 해시 저장(BCrypt 등)
  - `picture (varchar)` → `picture (varchar(1000))`
    - 사유: 외부 스토리지/서드파티 URL 길이 대응
  - `info (varchar(100))` (동일 유지)
    - 사유: 간단한 메모/태그 용 필드 유지
  - `lastConTime` → `last_conn_time (timestamp)`
    - 사유: 스네이크 케이스 통일, 의미 명확화(마지막 접속 시간)
  - `active (varchar DEFAULT 'active')` → `status (varchar(20) DEFAULT 'ACTIVE')`
    - 사유: 상태를 열거형 제약으로 관리(ACTIVE/INACTIVE/SUSPENDED), 데이터 정합성 향상
  - `role (신규, varchar(20) DEFAULT 'ROLE_USER')`
    - 사유: 역할 기반 접근 제어(RBAC) 지원
  - `coach_check (boolean DEFAULT false)` (동일 의미 유지)
    - 사유: 기능 플래그 성격 유지
  - `created_at/updated_at (timestamp)` (일관화)
    - 사유: 모든 테이블의 표준 감사 컬럼 통일

- 분리 테이블(정규화)
  - `user_schema.profiles`
    - `bio (TEXT)`, `avatar_url (varchar(500))`, `settings (JSONB)`
    - 사유: 가변/대용량 특성(소개/아바타/개인화 설정)을 기본 엔티티에서 분리 → 캐시/쿼리 최적화
  - `user_schema.settings`
    - `setting_key (varchar(100))`, `setting_value (TEXT)` (UNIQUE (user_id, setting_key))
    - 사유: 사용자별 키/값 설정의 확장성(버전/실험 설정 등) 및 조회 효율성 개선

---

### 2) 챗봇 도메인: `chatbot` → `chat_schema.chatbots`

- 매핑 개요
  - 기존 `bot_id` → `id`
  - 기존 `intimacy` → `intimacy_level`

- 컬럼 변경/추가 사유
  - `id (UUID)`
    - 사유: 전역 참조 일관성
  - `name (varchar(100))`, `display_name (varchar(100))` (신규)
    - 사유: 시스템 내부명/표시명 분리로 운영/UX 동시 최적화
  - `description (TEXT)` (신규)
    - 사유: 챗봇 소개/메타정보 저장
  - `bot_type (varchar(50))` (유지)
    - 사유: 제공자/종류 구분(gpt/claude/custom) + 체크 제약으로 데이터 품질 강화.
  - `model_name (varchar(100))` (신규)
    - 사유: LLM 모델 버전 식별(요금/성능 정책 연결)
  - `personality (JSONB)` (신규)
    - 사유: 성격/화법/가드레일/Few-shot 예시 등 동적 지시어 관리
  - `system_prompt (TEXT)` (신규)
    - 사유: 모델 시스템 지시어 저장(핵심 프롬프팅 근거)
  - `capabilities (JSONB)` (신규)
    - 사유: 응답 포맷/안전 정책/최대 길이 등 기능 플래그 관리
  - `settings (JSONB)` (신규)
    - 사유: 기타 확장 설정(플러그인/툴 호출 정책 등)용
  - `intimacy_level (integer CHECK 0~100)`
    - 사유: 범위 제약으로 데이터 일관성
  - `avatar_url (varchar(500))` (기존 `bot_img_url` 확장)
    - 사유: URL 길이 및 외부 호스팅 대응
  - `is_active (boolean DEFAULT true)` (신규)
    - 사유: 운영상 비활성화 플래그 필요
  - `created_by (UUID)` (신규 FK: user)
    - 사유: 생성자 추적/권한 검증
  - `created_at/updated_at (timestamp)` (표준화)

---

### 3) 채팅방 도메인: `chatroom` → `chat_schema.chatrooms`

- 매핑 개요
  - `room_id` → `id`, `room_name` → `name`

- 컬럼 변경/추가 사유
  - `id (UUID)`
    - 사유: 전역 참조 일관성
  - `name (varchar(100))`, `description (TEXT)` (신규)
    - 사유: UX 개선(설명/표시명 분리)
  - `chatbot_id (UUID FK)`, `user_id (UUID FK)`
    - 사유: 참조 무결성 보장 및 CASCADE/SET NULL 정책 반영
  - `settings (JSONB)` (기존 json → JSONB)
    - 사유: 인덱싱/연산 성능 개선
  - `context_data (JSONB)` (신규)
    - 사유: 대화 요약/사용자 선호/세션 상태 등 프롬프팅 컨텍스트 저장
  - `last_message_at (timestamp)`, `last_message_id (UUID)` (신규 + FK(messages))
    - 사유: 리스트/정렬 최적화 및 마지막 메시지 포인터 관리
  - `is_archived (boolean DEFAULT false)` (신규)
    - 사유: 아카이브 기능 지원
  - `is_deleted (boolean DEFAULT false)`
    - 사유: 기존 기본값 'true'의 불합리성 수정(신규 방은 기본 미삭제 상태여야 함)
  - `created_at/updated_at (timestamp)` (표준화)

---

### 4) 메시지 도메인: `message` → `chat_schema.messages`

- 매핑 개요
  - `messege_id` 오타 수정 및 네이밍 정책 단일화 → `id`
  - 복합 PK(방/봇/유저/메시지) → 단일 PK + 유니크 제약(방, 시퀀스)

- 컬럼 변경/추가 사유
  - `id (UUID)`
    - 사유: 전역 참조 일관성
  - `chatroom_id (UUID FK)`
    - 사유: 참조 무결성 및 삭제 정책 통일
  - `sender_type (varchar(20) CHECK in('user','bot','system'))` (유지/제약 강화)
    - 사유: 값 도메인 명확화
  - `sender_id (UUID)` (신규)
    - 사유: 발신자 식별(특히 bot/system 이벤트의 소스 추적)
  - `content (TEXT)` (확장)
    - 사유: 장문/코드블록 대응
  - `content_type (varchar(20) CHECK in('text','code','system'))` (신규)
    - 사유: 렌더링 정책
  - `metadata (JSONB)` (기존 json → JSONB)
    - 사유: 가변 메타(툴 호출 결과/첨부 등) 고성능 저장.
  - `parent_message_id (UUID FK self)` (신규)
    - 사유: 쓰레딩/답글 지원.
  - `sequence_number (bigint)` + `UNIQUE (chatroom_id, sequence_number)` (신규)
    - 사유: 정렬/페이지네이션 성능 최적화, 비즈니스 키로 접근성 향상
  - `token_count (integer)` (신규)
    - 사유: LLM 입력/출력 토큰 집계 기록(비용/성능 분석)
  - `processing_time_ms (integer)` (신규)
    - 사유: 응답 지연 모니터링.
  - `is_edited/edited_at`, `is_deleted/deleted_at` (신규)
    - 사유: 편집/삭제 이력 관리.
  - `created_at/updated_at (timestamp)` (표준화)

---

### 5) 보관함 도메인: `store` (현재 일시 제거)

- 사유
  - 챗봇 테스트 후 도입 예정으로 임시 삭제
  - 추후 재도입 예정

---

### 6) 인증 도메인: `auth_schema` (신규)

- 주요 테이블 및 핵심 컬럼 사유
  - `email_verifications (user_id, token_hash, expires_at, verified)`
    - 사유: 이메일 소유 증명, 토큰 해시로 보안 강화.
  - `login_attempts (user_id/email, succeeded, ip_address, user_agent)`
    - 사유: 보안 감사/이상 징후 탐지.
  - `refresh_tokens (user_id, token, expires_at, revoked, device_id, user_agent, ip_address, rotated_from_id)`
    - 사유: 토큰 수명/회전 이력 추적
  - `token_blacklist (token_hash, token_type, expires_at)`
    - 사유: 강제 만료/블랙리스트 관리
  - `password_reset_tokens (user_id, token_hash, expires_at, used)`
    - 사유: 안전한 비밀번호 재설정 플로우
  - `auth_events (user_id, event_type, metadata)`
    - 사유: 감사/진단용 이벤트 로그

---

### 7) 과금 도메인: `billing` (신규)

- `ai_usage_events`
  - `provider/model` (신규): 공급자/모델별 단가 정책 반영
  - `input_tokens/output_tokens` (신규): 토큰 단위 사용량 기록
  - `cost_in/cost_out` (신규): 입력/출력 비용 분리 집계
  - `request_id` (UNIQUE): 외부 API 청구 ID 등 중복 방지 키
  - `meta (JSONB)`: 호출 파라미터/오류 등 부가정보 저장
  - FK: `user_id`/`chatroom_id` SET NULL
    - 사유: 외부 엔터티 삭제 후에도 청구 이력 보존

- `monthly_user_costs`
  - PK: `(billing_month, user_id)`
    - 사유: 월별 사용자 단위 집계 키
  - `input_tokens/output_tokens/total_cost` (신규)
    - 사유: 과금 모델/한도/알림 기능 구현

---

### 8) 공통 정책

- `JSON` → `JSONB` 전환
  - 사유: 인덱싱/연산 성능 우수, 향후 질의 최적화 용이.

- 타임스템프 컬럼 표준화: `created_at`, `updated_at`

- FK 및 제약 강화
  - 사유: 도메인 무결성 보장 + 삭제 정책(CASCADE/SET NULL) 명확화

- 인덱스 정책
  - 예: `messages (chatroom_id, sequence_number)`
  - 사유: 대화 페이징/정렬의 실사용 시나리오 최적화

---

### 9) 마이크로서비스/운영 관점


- 비용/성능 모니터링 지표 내장(`token_count`, `processing_time_ms`, `ai_usage_events`)
  - 사유: 비용 예측 및 최적화 근거 자료 확보

- 보안 강건화(`password_hash`, 토큰/블랙리스트, 이벤트 로그)
  - 사유: 인증 흐름 안전성 및 감사 가능성 강화.

---


