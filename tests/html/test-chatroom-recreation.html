<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>채팅방 재생성 테스트</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .log { background: #f5f5f5; padding: 10px; margin: 10px 0; white-space: pre-wrap; }
        button { padding: 10px 15px; margin: 5px; }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>채팅방 재생성 테스트</h1>
    
    <div class="test-section">
        <h3>테스트 설정</h3>
        <input type="text" id="userId" placeholder="사용자 ID" value="test-user-123">
        <input type="text" id="chatbotId" placeholder="챗봇 ID" value="test-bot-456">
        <input type="text" id="roomName" placeholder="채팅방 이름" value="테스트 채팅방">
    </div>

    <div class="test-section">
        <h3>테스트 실행</h3>
        <button onclick="createRoom()">1. 채팅방 생성</button>
        <button onclick="leaveRoom()">2. 채팅방 나가기</button>
        <button onclick="createRoomAgain()">3. 다시 채팅방 생성</button>
        <button onclick="listRooms()">4. 채팅방 목록 조회</button>
        <button onclick="clearLog()">로그 지우기</button>
    </div>

    <div class="test-section">
        <h3>테스트 결과</h3>
        <div id="log" class="log"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080/api/chat';
        let currentRoomId = null;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : '';
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        async function createRoom() {
            const userId = document.getElementById('userId').value;
            const chatbotId = document.getElementById('chatbotId').value;
            const roomName = document.getElementById('roomName').value;

            try {
                const response = await fetch(`${API_BASE}/chatrooms`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        userId: userId,
                        chatbotId: chatbotId,
                        name: roomName,
                        concept: 'FRIEND',
                        intimacyLevel: 2
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    currentRoomId = data.id;
                    log(`채팅방 생성 성공: ID=${data.id}, 이름=${data.name}`, 'success');
                } else {
                    log(`채팅방 생성 실패: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`채팅방 생성 오류: ${error.message}`, 'error');
            }
        }

        async function leaveRoom() {
            if (!currentRoomId) {
                log('먼저 채팅방을 생성하세요', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/chatrooms/${currentRoomId}/leave`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        userId: document.getElementById('userId').value
                    })
                });

                if (response.ok || response.status === 204) {
                    log(`채팅방 나가기 성공: ID=${currentRoomId}`, 'success');
                } else {
                    log(`채팅방 나가기 실패: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`채팅방 나가기 오류: ${error.message}`, 'error');
            }
        }

        async function createRoomAgain() {
            const userId = document.getElementById('userId').value;
            const chatbotId = document.getElementById('chatbotId').value;
            const roomName = document.getElementById('roomName').value + ' (재생성)';

            try {
                const response = await fetch(`${API_BASE}/chatrooms`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        userId: userId,
                        chatbotId: chatbotId,
                        name: roomName,
                        concept: 'FRIEND',
                        intimacyLevel: 2
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    const newRoomId = data.id;
                    log(`채팅방 재생성 성공: ID=${newRoomId}, 이름=${data.name}`, 'success');
                    
                    if (currentRoomId && newRoomId !== currentRoomId) {
                        log(`✅ 새로운 채팅방이 생성되었습니다! (이전: ${currentRoomId}, 새: ${newRoomId})`, 'success');
                    } else {
                        log(`❌ 기존 채팅방이 복구되었습니다. (ID: ${newRoomId})`, 'error');
                    }
                    
                    currentRoomId = newRoomId;
                } else {
                    log(`채팅방 재생성 실패: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`채팅방 재생성 오류: ${error.message}`, 'error');
            }
        }

        async function listRooms() {
            const userId = document.getElementById('userId').value;

            try {
                const response = await fetch(`${API_BASE}/chatrooms?userId=${userId}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    log(`채팅방 목록 조회 성공: ${data.length}개`, 'success');
                    data.forEach(room => {
                        log(`- ID: ${room.id}, 이름: ${room.name}, 삭제됨: ${room.isDeleted || false}`);
                    });
                } else {
                    log(`채팅방 목록 조회 실패: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`채팅방 목록 조회 오류: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>
