erDiagram
    %% ========================
    %% User Domain (user_schema)
    %% ========================
    user_schema_app_user {
        UUID id PK
        VARCHAR email "UNIQUE"
        VARCHAR first_name
        VARCHAR last_name
        VARCHAR name
        VARCHAR password_hash
        VARCHAR picture
        VARCHAR info
        TIMESTAMP last_conn_time
        VARCHAR status "ACTIVE|INACTIVE|SUSPENDED"
        VARCHAR role "ROLE_USER|ROLE_ADMIN"
        BOOLEAN coach_check
        TIMESTAMP created_at
        TIMESTAMP updated_at
    }

    user_schema_profiles {
        BIGSERIAL id PK
        UUID user_id FK
        TEXT bio
        VARCHAR avatar_url
        JSONB settings
        TIMESTAMP created_at
        TIMESTAMP updated_at
    }

    user_schema_settings {
        BIGSERIAL id PK
        UUID user_id FK
        VARCHAR setting_key
        TEXT setting_value
        TIMESTAMP created_at
        TIMESTAMP updated_at
    }

    %% ========================
    %% Chat Domain (chat_schema)
    %% ========================
    chat_schema_chatbots {
        UUID id PK
        VARCHAR name
        VARCHAR display_name
        TEXT description
        VARCHAR bot_type "gpt|claude|custom"
        VARCHAR model_name
        JSONB personality
        TEXT system_prompt
        JSONB capabilities
        JSONB settings "concept: FRIEND|HONEY|COWORKER|SENIOR|BOSS"
        INTEGER intimacy_level "1-3"
        VARCHAR avatar_url
        BOOLEAN is_active
        TIMESTAMP created_at
        TIMESTAMP updated_at
        UUID created_by FK
    }

    chat_schema_chatrooms {
        UUID id PK
        VARCHAR name
        TEXT description
        UUID chatbot_id FK
        UUID user_id FK
        JSONB settings
        JSONB context_data
        TIMESTAMP last_message_at
        UUID last_message_id FK
        BOOLEAN is_archived
        BOOLEAN is_deleted
        TIMESTAMP created_at
        TIMESTAMP updated_at
    }

    chat_schema_messages {
        UUID id PK
        UUID chatroom_id FK
        VARCHAR sender_type "user|bot|system"
        UUID sender_id
        TEXT content
        VARCHAR content_type "text|code|system|json"
        JSONB metadata
        UUID parent_message_id FK
        BIGINT sequence_number "UNIQUE(chatroom_id, sequence_number)"
        INTEGER token_count
        INTEGER processing_time_ms
        BOOLEAN is_edited
        TIMESTAMP edited_at
        BOOLEAN is_deleted
        TIMESTAMP deleted_at
        TIMESTAMP created_at
        TIMESTAMP updated_at
    }

    chat_schema_intimacy_progress {
        UUID id PK
        UUID chatroom_id FK
        UUID user_id FK
        INTEGER intimacy_level "1-3"
        INTEGER total_corrections
        TEXT last_feedback
        TIMESTAMP last_updated
        JSONB progress_data
    }

    %% ========================
    %% Auth Domain (auth_schema)
    %% ========================
    auth_schema_email_verifications {
        BIGSERIAL id PK
        UUID user_id FK
        VARCHAR token_hash
        TIMESTAMP expires_at
        BOOLEAN verified
        TIMESTAMP created_at
    }

    auth_schema_login_attempts {
        BIGSERIAL id PK
        UUID user_id FK
        VARCHAR email
        BOOLEAN succeeded
        VARCHAR ip_address
        VARCHAR user_agent
        TIMESTAMP created_at
    }

    auth_schema_refresh_tokens {
        BIGSERIAL id PK
        UUID user_id FK
        TEXT token
        TIMESTAMP issued_at
        TIMESTAMP expires_at
        BOOLEAN revoked
        BIGINT rotated_from_id FK
        VARCHAR device_id
        VARCHAR user_agent
        VARCHAR ip_address
    }

    auth_schema_token_blacklist {
        BIGSERIAL id PK
        VARCHAR token_hash
        VARCHAR token_type
        VARCHAR reason
        TIMESTAMP created_at
        TIMESTAMP expires_at
    }

    auth_schema_password_reset_tokens {
        BIGSERIAL id PK
        UUID user_id FK
        VARCHAR token_hash
        TIMESTAMP expires_at
        BOOLEAN used
        TIMESTAMP created_at
    }

    auth_schema_auth_events {
        BIGSERIAL id PK
        UUID user_id FK
        VARCHAR event_type
        JSONB metadata
        TIMESTAMP created_at
    }

    %% ========================
    %% Billing Domain
    %% ========================
    billing_ai_usage_events {
        UUID id PK
        TIMESTAMP event_time
        UUID user_id FK
        UUID chatroom_id FK
        TEXT provider
        TEXT model
        TEXT request_id
        INT input_tokens
        INT output_tokens
        NUMERIC cost_in
        NUMERIC cost_out
        JSONB meta
    }

    billing_monthly_user_costs {
        DATE billing_month PK
        UUID user_id PK
        BIGINT input_tokens
        BIGINT output_tokens
        NUMERIC cost_in
        NUMERIC cost_out
        NUMERIC total_cost
        TIMESTAMP last_aggregated_at
    }

    %% ========================
    %% Relationships
    %% ========================
    user_schema_app_user ||--o{ user_schema_profiles : "user_id"
    user_schema_app_user ||--o{ user_schema_settings : "user_id"

    user_schema_app_user ||--o{ chat_schema_chatrooms : "user_id"
    chat_schema_chatbots ||--o{ chat_schema_chatrooms : "chatbot_id"
    chat_schema_chatrooms ||--o{ chat_schema_messages : "chatroom_id"
    chat_schema_messages ||--o{ chat_schema_messages : "parent_message_id"
    chat_schema_messages ||--o| chat_schema_chatrooms : "last_message_id"
    user_schema_app_user ||--o{ chat_schema_chatbots : "created_by"
    
    chat_schema_chatrooms ||--o| chat_schema_intimacy_progress : "chatroom_id"
    user_schema_app_user ||--o{ chat_schema_intimacy_progress : "user_id"

    user_schema_app_user ||--o{ auth_schema_email_verifications : "user_id"
    user_schema_app_user ||--o{ auth_schema_login_attempts : "user_id"
    user_schema_app_user ||--o{ auth_schema_refresh_tokens : "user_id"
    auth_schema_refresh_tokens ||--o| auth_schema_refresh_tokens : "rotated_from_id"
    user_schema_app_user ||--o{ auth_schema_password_reset_tokens : "user_id"
    user_schema_app_user ||--o{ auth_schema_auth_events : "user_id"

    user_schema_app_user ||--o{ billing_ai_usage_events : "user_id"
    chat_schema_chatrooms ||--o{ billing_ai_usage_events : "chatroom_id"
    billing_monthly_user_costs }o--|| user_schema_app_user : "user_id"
