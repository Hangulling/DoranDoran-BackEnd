<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DoranDoran Chat Test - Í∞úÏÑ†Îêú UX</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .test-guide {
            background: rgba(255,255,255,0.1);
            margin-top: 15px;
            padding: 15px;
            border-radius: 10px;
            font-size: 0.9em;
        }
        
        .test-guide h4 {
            margin-bottom: 10px;
            color: #fff;
        }
        
        .test-guide ul {
            list-style: none;
            padding: 0;
        }
        
        .test-guide li {
            margin: 5px 0;
            padding-left: 20px;
            position: relative;
        }
        
        .test-guide li:before {
            content: "‚úì";
            position: absolute;
            left: 0;
            color: #4CAF50;
            font-weight: bold;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            padding: 30px;
        }
        
        .left-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .right-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #e1e8ed;
        }
        
        .section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.2em;
            border-bottom: 2px solid #3498db;
            padding-bottom: 5px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #34495e;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 5px rgba(52, 152, 219, 0.3);
        }
        
        .btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 5px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }
        
        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #27ae60, #229954);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }
        
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: 600;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .chat-container {
            background: white;
            border: 1px solid #e1e8ed;
            border-radius: 10px;
            height: 500px;
            display: flex;
            flex-direction: column;
        }
        
        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background: #f8f9fa;
        }
        
        .message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 15px;
            max-width: 80%;
            word-wrap: break-word;
        }
        
        .message.user {
            background: #3498db;
            color: white;
            margin-left: auto;
        }
        
        .message.bot {
            background: #ecf0f1;
            color: #2c3e50;
            margin-right: auto;
        }
        
        .message.system {
            background: #f39c12;
            color: white;
            text-align: center;
            margin: 0 auto;
            max-width: 100%;
        }
        
        .message.vocabulary {
            background: #e3f2fd;
            color: #1565c0;
            margin-right: auto;
            border-left: 3px solid #2196f3;
        }
        
        .message.translation {
            background: #f3e5f5;
            color: #6a1b9a;
            margin-right: auto;
            border-left: 3px solid #9c27b0;
        }
        
        .message.intimacy {
            background: #fff3e0;
            color: #e65100;
            margin-left: auto;
            border-left: 3px solid #ff9800;
        }
        
        .chat-input {
            padding: 15px;
            border-top: 1px solid #e1e8ed;
            display: flex;
            gap: 10px;
        }
        
        .chat-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 20px;
            outline: none;
        }
        
        .chat-input input:focus {
            border-color: #3498db;
        }
        
        .room-list {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .room-item {
            padding: 10px;
            border: 1px solid #e1e8ed;
            border-radius: 5px;
            margin-bottom: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .room-item:hover {
            background: #e8f4f8;
        }
        
        .room-item.active {
            background: #3498db;
            color: white;
        }
        
        .sse-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }
        
        .status-indicator.connected {
            background: #27ae60;
            box-shadow: 0 0 10px rgba(39, 174, 96, 0.5);
        }
        
        .status-indicator.disconnected {
            background: #e74c3c;
        }
        
        .log-container {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }
        
        .log-entry.error {
            color: #e74c3c;
        }
        
        .log-entry.success {
            color: #27ae60;
        }
        
        .log-entry.info {
            color: #3498db;
        }
        
        .hidden {
            display: none;
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .full-width {
            grid-column: 1 / -1;
        }
        
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            resize: vertical;
            min-height: 150px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ DoranDoran Chat Test</h1>
            <p>Í∞úÏÑ†Îêú UX - Ïù¥Î©îÏùº Í∏∞Î∞ò Î°úÍ∑∏Ïù∏ & ÏûêÎèô SSE Ïó∞Í≤∞</p>
            <div class="test-guide">
                <h4>üìã ÌÖåÏä§Ìä∏ Í∞ÄÏù¥Îìú</h4>
                <ul>
                    <li>Ïù¥Î©îÏùºÎ°ú Î°úÍ∑∏Ïù∏ (test1@example.com ~ test10@example.com)</li>
                    <li>Ïª®ÏÖâÍ≥º ÏπúÎ∞ÄÎèÑ ÏÑ†ÌÉù ÌõÑ Ï±ÑÌåÖÎ∞© ÏÉùÏÑ±</li>
                    <li>ÏûêÎèô SSE Ïó∞Í≤∞ Î∞è Ï±ÑÌåÖ ÏãúÏûë</li>
                    <li>Ï±óÎ¥á ÌîÑÎ°¨ÌîÑÌä∏ Ï°∞Ìöå/ÏàòÏ†ï Í∞ÄÎä•</li>
                </ul>
            </div>
                </div>
                
        <div class="main-content">
            <!-- ÏôºÏ™Ω Ìå®ÎÑê -->
            <div class="left-panel">
                <!-- ÏÇ¨Ïö©Ïûê Î°úÍ∑∏Ïù∏ ÏÑπÏÖò -->
                <div class="section">
                    <h3>üîê ÏÇ¨Ïö©Ïûê Î°úÍ∑∏Ïù∏</h3>
                    <div class="form-group">
                        <label for="userEmail">Ïù¥Î©îÏùº Ï£ºÏÜå</label>
                        <input type="email" id="userEmail" placeholder="test1@example.com" value="test1@example.com">
                    </div>
                    <button class="btn" onclick="loginWithEmail()">Î°úÍ∑∏Ïù∏</button>
                    <div id="loginStatus" class="status hidden"></div>
            </div>
            
                <!-- Ï±ÑÌåÖÎ∞© ÏÉùÏÑ± ÏÑπÏÖò -->
                <div class="section">
                    <h3>üè† Ï±ÑÌåÖÎ∞© ÏÉùÏÑ±</h3>
                    <div class="form-group">
                        <label for="roomName">Ï±ÑÌåÖÎ∞© Ïù¥Î¶Ñ</label>
                        <input type="text" id="roomName" placeholder="ÌÖåÏä§Ìä∏ Ï±ÑÌåÖÎ∞©" value="ÌÖåÏä§Ìä∏ Ï±ÑÌåÖÎ∞©">
                </div>
                    <div class="form-group">
                        <label for="concept">Ïª®ÏÖâ</label>
                        <select id="concept">
                            <option value="FRIEND">ÏπúÍµ¨</option>
                            <option value="HONEY">ÍøÄ</option>
                            <option value="COWORKER">ÎèôÎ£å</option>
                            <option value="SENIOR">ÏÑ†Î∞∞</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="intimacyLevel">ÏπúÎ∞ÄÎèÑ Î†àÎ≤®</label>
                        <select id="intimacyLevel">
                            <option value="1">1 - Í≤©ÏãùÏ≤¥/Ï°¥ÎåìÎßê</option>
                            <option value="2" selected>2 - Î∂ÄÎìúÎü¨Ïö¥ Ï°¥ÎåìÎßê</option>
                            <option value="3">3 - ÏπúÍ∑ºÌïú Î∞òÎßê</option>
                        </select>
                    </div>
                    <button class="btn btn-success" onclick="createAndEnterRoom()">Ï±ÑÌåÖÎ∞© ÏÉùÏÑ± & ÏûÖÏû•</button>
                    <div id="roomStatus" class="status hidden"></div>
                    </div>
                    
                <!-- Ï±ÑÌåÖÎ∞© Î™©Î°ù ÏÑπÏÖò -->
                <div class="section">
                    <h3>üìã Ï±ÑÌåÖÎ∞© Î™©Î°ù</h3>
                    <button class="btn" onclick="loadChatRooms()">Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®</button>
                    <div id="roomList" class="room-list"></div>
                    </div>
                
                <!-- SSE Ïó∞Í≤∞ ÏÉÅÌÉú ÏÑπÏÖò -->
                <div class="section">
                    <h3>üîó SSE Ïó∞Í≤∞ ÏÉÅÌÉú</h3>
                    <div class="sse-status">
                        <span class="status-indicator disconnected" id="sseIndicator"></span>
                        <span id="sseStatusText">Ïó∞Í≤∞ ÎÅäÍπÄ</span>
                    </div>
                    <button class="btn" onclick="connectSSE()" id="connectBtn">SSE Ïó∞Í≤∞</button>
                    <button class="btn btn-danger" onclick="disconnectSSE()" id="disconnectBtn">Ïó∞Í≤∞ ÎÅäÍ∏∞</button>
                </div>
                </div>

            <!-- Ïò§Î•∏Ï™Ω Ìå®ÎÑê -->
            <div class="right-panel">
                <!-- Ï±ÑÌåÖÎ∞© Ï†ïÎ≥¥ Î∞è ÎÇòÍ∞ÄÍ∏∞ (Ï±ÑÌåÖÎ∞© ÏûÖÏû• ÌõÑÏóêÎßå ÌëúÏãú) -->
                <div class="section hidden" id="chatRoomInfo">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h3>üí¨ Ï±ÑÌåÖÎ∞©</h3>
                        <button class="btn btn-danger" onclick="leaveChatRoom()" style="margin: 0;">ÎÇòÍ∞ÄÍ∏∞</button>
                    </div>
                    <div id="roomInfoDisplay" style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                        <p style="margin: 5px 0;"><strong>Ï±ÑÌåÖÎ∞© ID:</strong> <span id="currentRoomIdDisplay">-</span></p>
                    </div>
                    
                    <!-- ÏπúÎ∞ÄÎèÑ Î≥ÄÍ≤Ω UI -->
                    <div class="form-group" style="margin-top: 15px;">
                        <label for="currentIntimacyLevel">ÌòÑÏû¨ ÏπúÎ∞ÄÎèÑ Î†àÎ≤®</label>
                        <select id="currentIntimacyLevel">
                            <option value="1">1 - Í≤©ÏãùÏ≤¥/Ï°¥ÎåìÎßê</option>
                            <option value="2">2 - Î∂ÄÎìúÎü¨Ïö¥ Ï°¥ÎåìÎßê</option>
                            <option value="3">3 - ÏπúÍ∑ºÌïú Î∞òÎßê</option>
                        </select>
                        <button class="btn btn-warning" onclick="updateIntimacyLevel()" style="margin-top: 10px;">ÏπúÎ∞ÄÎèÑ Î≥ÄÍ≤Ω</button>
                    </div>
                </div>
                
                <!-- Ï±ÑÌåÖ Ïù∏ÌÑ∞ÌéòÏù¥Ïä§ -->
                <div class="section">
                    <h3>üí¨ Ï±ÑÌåÖ</h3>
                    <div class="chat-container">
                        <div id="chatMessages" class="chat-messages">
                            <div class="message system">Ï±ÑÌåÖÎ∞©Ïóê ÏûÖÏû•ÌïòÎ©¥ Ïó¨Í∏∞Ïóê Î©îÏãúÏßÄÍ∞Ä ÌëúÏãúÎê©ÎãàÎã§.</div>
                    </div>
                <div class="chat-input">
                            <input type="text" id="messageInput" placeholder="Î©îÏãúÏßÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî..." onkeypress="handleKeyPress(event)">
                        <button class="btn" onclick="sendMessage()">Ï†ÑÏÜ°</button>
                    </div>
                    </div>
                </div>
                
                <!-- Ï±óÎ¥á Í¥ÄÎ¶¨ ÏÑπÏÖò (Ï±ÑÌåÖÎ∞© ÏûÖÏû• ÌõÑÏóêÎßå ÌëúÏãú) -->
                <div class="section hidden" id="chatbotManagement">
                    <h3>ü§ñ Ï±óÎ¥á Í¥ÄÎ¶¨</h3>
                    <div class="form-group">
                        <label for="agentType">ÏóêÏù¥Ï†ÑÌä∏ ÌÉÄÏûÖ</label>
                        <select id="agentType" onchange="loadChatbotPrompt()">
                            <option value="conversation">ÎåÄÌôî (ConversationAgent)</option>
                            <option value="intimacy">ÏπúÎ∞ÄÎèÑ Î∂ÑÏÑù (IntimacyAgent)</option>
                            <option value="vocabulary">Ïñ¥Ìúò Ï∂îÏ∂ú (VocabularyAgent)</option>
                            <option value="translation">Î≤àÏó≠ (TranslationAgent)</option>
                        </select>
                    </div>
                    
                    <!-- Base Prompt (ÏàòÏ†ï Í∞ÄÎä•) -->
                    <div class="form-group">
                        <label for="basePromptText">
                            üìù Base Prompt (ÏàòÏ†ï Í∞ÄÎä•)
                            <span style="font-size: 0.9em; color: #666; font-weight: normal;">
                                - Í∏∞Î≥∏ ÏßÄÏãúÏÇ¨Ìï≠ÏùÑ ÏûëÏÑ±ÌïòÏÑ∏Ïöî
                            </span>
                        </label>
                        <textarea id="basePromptText" rows="8" placeholder="Base PromptÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî..."></textarea>
                    </div>
                    
                    <!-- Dynamic Directives (ÏùΩÍ∏∞ Ï†ÑÏö©) -->
                    <div class="form-group" id="dynamicDirectivesSection" style="display: none;">
                        <label for="dynamicDirectivesText">
                            üîÑ Dynamic Directives (ÏûêÎèô ÏÉùÏÑ±, ÏùΩÍ∏∞ Ï†ÑÏö©)
                            <span style="font-size: 0.9em; color: #666; font-weight: normal;">
                                - ConceptÏôÄ Intimacy LevelÏóê Îî∞Îùº ÏûêÎèôÏúºÎ°ú Ï∂îÍ∞ÄÎê©ÎãàÎã§
                            </span>
                        </label>
                        <textarea id="dynamicDirectivesText" rows="6" readonly 
                            style="background: #f0f0f0; cursor: not-allowed;" 
                            placeholder="Ï±ÑÌåÖÎ∞© ÏûÖÏû• ÌõÑ ÏûêÎèô ÏÉùÏÑ±Îê©ÎãàÎã§..."></textarea>
                    </div>
                    
                    <!-- Ï†ÑÏ≤¥ ÌîÑÎ°¨ÌîÑÌä∏ ÎØ∏Î¶¨Î≥¥Í∏∞ -->
                    <div class="form-group" id="fullPromptSection" style="display: none;">
                        <label for="fullPromptText">
                            üëÅÔ∏è Ï†ÑÏ≤¥ ÌîÑÎ°¨ÌîÑÌä∏ ÎØ∏Î¶¨Î≥¥Í∏∞ (Ïã§Ï†ú AIÏóê Ï†ÑÎã¨ÎêòÎäî ÌîÑÎ°¨ÌîÑÌä∏)
                        </label>
                        <textarea id="fullPromptText" rows="12" readonly 
                            style="background: #f9f9f9; border: 2px solid #3498db; cursor: default;" 
                            placeholder="Ï±ÑÌåÖÎ∞© ÏûÖÏû• ÌõÑ ÌôïÏù∏Ìï† Ïàò ÏûàÏäµÎãàÎã§..."></textarea>
                    </div>
                    
                    <div class="grid-2">
                        <button class="btn" onclick="loadChatbotPrompt()">ÌîÑÎ°¨ÌîÑÌä∏ Ï°∞Ìöå</button>
                        <button class="btn btn-warning" onclick="updateChatbotPrompt()">Base Prompt ÏàòÏ†ï</button>
                        <button class="btn btn-danger full-width" onclick="resetChatbotPrompt()">Í∏∞Î≥∏Í∞íÏúºÎ°ú Î¶¨ÏÖã</button>
                    </div>
                    <div id="promptDisplay" class="status hidden"></div>
            </div>

                <!-- Directives ÏÑ§Ï†ï Ìå®ÎÑê (Í∞úÎ∞úÏûêÏö©) -->
                <div class="section">
                    <h3>‚öôÔ∏è Directives ÏÑ§Ï†ï (Í∞úÎ∞úÏûêÏö©)</h3>
                    
                    <div style="margin-bottom: 15px;">
                        <label>ÌòÑÏû¨ Ï±óÎ¥á ID:</label>
                        <input type="text" id="directiveChatbotId" 
                               placeholder="Ï±óÎ¥á ID ÏûÖÎ†• ÎòêÎäî ÏûêÎèô" 
                               style="width: 100%; padding: 8px; margin-top: 5px;">
                        <button onclick="loadDirectives()" 
                                style="width: 100%; margin-top: 5px; padding: 10px; background: #4facfe; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            ÌòÑÏû¨ ÏÑ§Ï†ï Î∂àÎü¨Ïò§Í∏∞
                        </button>
                    </div>
                    
                    <!-- Concept Directive -->
                    <div style="background: white; padding: 15px; border-radius: 5px; margin-bottom: 10px;">
                        <h4 style="margin-bottom: 10px;">Concept Directive</h4>
                        <label>
                            <input type="checkbox" id="conceptEnabled" checked>
                            ÌôúÏÑ±Ìôî
                        </label>
                        <textarea id="conceptCustom" 
                                  placeholder="Ïª§Ïä§ÌÖÄ Ïª®ÏÖâ ÏßÄÏπ® (ÎπÑÏñ¥ÏûàÏúºÎ©¥ Í∏∞Î≥∏ ÌïòÎìúÏΩîÎî© ÏÇ¨Ïö©)"
                                  style="width: 100%; margin-top: 10px; padding: 8px; min-height: 60px; border-radius: 5px; border: 1px solid #ddd;"></textarea>
                    </div>
                    
                    <!-- Intimacy Directive -->
                    <div style="background: white; padding: 15px; border-radius: 5px; margin-bottom: 10px;">
                        <h4 style="margin-bottom: 10px;">Intimacy Directive</h4>
                        <label>
                            <input type="checkbox" id="intimacyEnabled" checked>
                            ÌôúÏÑ±Ìôî
                        </label>
                        <textarea id="intimacyCustom" 
                                  placeholder="Ïª§Ïä§ÌÖÄ ÏπúÎ∞ÄÎèÑ ÏßÄÏπ® (ÎπÑÏñ¥ÏûàÏúºÎ©¥ Í∏∞Î≥∏ ÌïòÎìúÏΩîÎî© ÏÇ¨Ïö©)"
                                  style="width: 100%; margin-top: 10px; padding: 8px; min-height: 60px; border-radius: 5px; border: 1px solid #ddd;"></textarea>
                    </div>
                    
                    <!-- Language Directive -->
                    <div style="background: white; padding: 15px; border-radius: 5px; margin-bottom: 10px;">
                        <h4 style="margin-bottom: 10px;">Language Directive</h4>
                        <label>
                            <input type="checkbox" id="languageEnabled" checked>
                            ÌôúÏÑ±Ìôî
                        </label>
                        <div style="margin-top: 10px;">
                            <label>Í∏∞Î≥∏ Ïñ∏Ïñ¥:</label>
                            <select id="defaultLanguage" 
                                    style="width: 100%; padding: 8px; margin-top: 5px; border-radius: 5px;">
                                <option value="ko">ÌïúÍµ≠Ïñ¥</option>
                                <option value="en">ÏòÅÏñ¥</option>
                                <option value="ja">ÏùºÎ≥∏Ïñ¥</option>
                                <option value="zh">Ï§ëÍµ≠Ïñ¥</option>
                                <option value="fr">ÌîÑÎûëÏä§Ïñ¥</option>
                                <option value="de">ÎèÖÏùºÏñ¥</option>
                                <option value="es">Ïä§ÌéòÏù∏Ïñ¥</option>
                            </select>
                        </div>
                        <label style="margin-top: 10px; display: block;">
                            <input type="checkbox" id="allowUserOverride" checked>
                            ÏÇ¨Ïö©Ïûê Ïñ∏Ïñ¥ Ïò§Î≤ÑÎùºÏù¥Îìú ÌóàÏö©
                        </label>
                    </div>
                    
                    <button onclick="updateDirectives()" 
                            style="width: 100%; padding: 12px; background: #43a047; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 1em; font-weight: bold;">
                        Directives Ï†ÅÏö©
                    </button>
                    
                    <div id="directiveStatus" class="status hidden" style="margin-top: 10px;"></div>
                </div>

        <!-- Î°úÍ∑∏ ÏÑπÏÖò -->
                <div class="section">
                    <h3>üìä Î°úÍ∑∏</h3>
                    <button class="btn" onclick="clearLogs()">Î°úÍ∑∏ ÏßÄÏö∞Í∏∞</button>
                    <div id="logContainer" class="log-container">
                        <div class="log-entry info">ÏãúÏä§ÌÖúÏù¥ ÏãúÏûëÎêòÏóàÏäµÎãàÎã§.</div>
                </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Ï†ÑÏó≠ Î≥ÄÏàò
        let currentUserId = null;
        let currentRoomId = null;
        let currentChatbotId = null;  // ÌòÑÏû¨ Ï±ÑÌåÖÎ∞©Ïùò Ï±óÎ¥á ID
        let eventSource = null;
        let isConnected = false;
        let conversationBuffer = '';  // ÎåÄÌôî Ï≤≠ÌÅ¨ Î≤ÑÌçº
        let displayedVocabulary = new Set();  // Ï§ëÎ≥µ Î∞©ÏßÄÏö©
        let pendingResponses = {
            intimacy: null,
            vocabulary: null,
            translation: null,
            conversation: null
        };
        let isLoadingResponse = false;

        // Î°úÍ∑∏ Ìï®Ïàò
        function log(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // Î°úÎî© UI Ìï®Ïàò
        function showLoadingMessage() {
            const chatMessages = document.getElementById('chatMessages');
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'ai-loading';
            loadingDiv.className = 'message bot';
            loadingDiv.style.fontStyle = 'italic';
            loadingDiv.style.opacity = '0.7';
            loadingDiv.textContent = 'AIÍ∞Ä ÎãµÎ≥ÄÏùÑ Ï§ÄÎπÑ Ï§ëÏûÖÎãàÎã§...';
            chatMessages.appendChild(loadingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            isLoadingResponse = true;
        }

        function hideLoadingMessage() {
            const loadingDiv = document.getElementById('ai-loading');
            if (loadingDiv) {
                loadingDiv.remove();
            }
            isLoadingResponse = false;
        }

        function clearLogs() {
            document.getElementById('logContainer').innerHTML = '<div class="log-entry info">Î°úÍ∑∏Í∞Ä ÏßÄÏõåÏ°åÏäµÎãàÎã§.</div>';
        }

        // ÏùëÎãµ Í¥ÄÎ¶¨ Ìï®Ïàò
        function checkAndDisplayAllResponses() {
            // Î™®Îì† AgentÍ∞Ä ÏùëÎãµÌñàÎäîÏßÄ ÌôïÏù∏
            if (pendingResponses.intimacy !== null && 
                pendingResponses.vocabulary !== null && 
                pendingResponses.translation !== null && 
                pendingResponses.conversation !== null) {
                
                hideLoadingMessage();
                
                // ÏàúÏÑúÎåÄÎ°ú ÌëúÏãú
                // 1. Intimacy ÌîºÎìúÎ∞± (ÍµêÏ†ï Ìè¨Ìï®)
                if (pendingResponses.intimacy.feedback) {
                    let message = `üìä ${pendingResponses.intimacy.feedback}`;
                    if (pendingResponses.intimacy.correctedSentence) {
                        message += `\n‚úèÔ∏è ÍµêÏ†ïÎêú Î¨∏Ïû•: ${pendingResponses.intimacy.correctedSentence}`;
                    }
                    addMessageToChat(message, 'intimacy', false);
                }
                
                // 2. Î¥á ÏùëÎãµ
                addMessageToChat(pendingResponses.conversation, 'bot', false);
                
                // 3. Vocabulary
                if (pendingResponses.vocabulary.word) {
                    const message = `üí° ÏÉàÎ°úÏö¥ ÌëúÌòÑ: ${pendingResponses.vocabulary.word}`;
                    addMessageToChat(message, 'vocabulary', false);
                }
                
                // 4. Translation
                if (pendingResponses.translation.text) {
                    addMessageToChat(pendingResponses.translation.text, 'translation', false);
                }
                
                // Ï¥àÍ∏∞Ìôî
                resetPendingResponses();
            }
        }

        function resetPendingResponses() {
            pendingResponses = {
                intimacy: null,
                vocabulary: null,
                translation: null,
                conversation: null
            };
        }

        // ÏÉÅÌÉú ÌëúÏãú Ìï®Ïàò
        function showStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status ${type}`;
            element.classList.remove('hidden');
        }

        // Ïù¥Î©îÏùºÎ°ú Î°úÍ∑∏Ïù∏
        async function loginWithEmail() {
            const email = document.getElementById('userEmail').value.trim();
            if (!email) {
                showStatus('loginStatus', 'Ïù¥Î©îÏùºÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.', 'error');
                return;
            }

            try {
                log(`Ïù¥Î©îÏùºÎ°ú Î°úÍ∑∏Ïù∏ ÏãúÎèÑ: ${email}`);
                const response = await fetch(`/api/chat/users/by-email?email=${encodeURIComponent(email)}`);
                
                if (response.ok) {
                    const user = await response.json();
                    currentUserId = user.id;
                    showStatus('loginStatus', `Î°úÍ∑∏Ïù∏ ÏÑ±Í≥µ: ${user.name} (${user.email})`, 'success');
                    log(`Î°úÍ∑∏Ïù∏ ÏÑ±Í≥µ: ${user.name} (${user.id})`, 'success');
                    
                    // Ï±ÑÌåÖÎ∞© Î™©Î°ù Î°úÎìú
                    loadChatRooms();
                } else if (response.status === 404) {
                    showStatus('loginStatus', 'ÏÇ¨Ïö©ÏûêÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.', 'error');
                    log(`ÏÇ¨Ïö©Ïûê ÏóÜÏùå: ${email}`, 'error');
                } else {
                    showStatus('loginStatus', 'Î°úÍ∑∏Ïù∏ Ïã§Ìå®', 'error');
                    log(`Î°úÍ∑∏Ïù∏ Ïã§Ìå®: ${response.status}`, 'error');
                }
            } catch (error) {
                showStatus('loginStatus', 'Î°úÍ∑∏Ïù∏ Ï§ë Ïò§Î•ò Î∞úÏÉù', 'error');
                log(`Î°úÍ∑∏Ïù∏ Ïò§Î•ò: ${error.message}`, 'error');
            }
        }

        // Ï±ÑÌåÖÎ∞© ÏÉùÏÑ± Î∞è ÏûÖÏû•
        async function createAndEnterRoom() {
            if (!currentUserId) {
                showStatus('roomStatus', 'Î®ºÏ†Ä Î°úÍ∑∏Ïù∏Ìï¥Ï£ºÏÑ∏Ïöî.', 'error');
                return;
            }

            const roomName = document.getElementById('roomName').value.trim();
            const concept = document.getElementById('concept').value;
            const intimacyLevel = parseInt(document.getElementById('intimacyLevel').value);

            if (!roomName) {
                showStatus('roomStatus', 'Ï±ÑÌåÖÎ∞© Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.', 'error');
                return;
            }

            try {
                log(`Ï±ÑÌåÖÎ∞© ÏÉùÏÑ± ÏãúÎèÑ: ${roomName} (${concept}, Î†àÎ≤® ${intimacyLevel})`);
                
                // conceptÎ≥Ñ Ï±óÎ¥á UUID Îß§Ìïë
                const chatbotIdMap = {
                    'FRIEND': '22222222-2222-2222-2222-222222222221',
                    'HONEY': '22222222-2222-2222-2222-222222222222',
                    'COWORKER': '22222222-2222-2222-2222-222222222223',
                    'SENIOR': '22222222-2222-2222-2222-222222222224'
                };
                
                const chatbotId = chatbotIdMap[concept];
                
                const response = await fetch('/api/chat/chatrooms', {
                    method: 'POST',
                    headers: {
                    'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: currentUserId,
                        chatbotId: chatbotId,
                        name: roomName,
                        concept: concept,
                        intimacyLevel: intimacyLevel
                    })
                });

                if (response.ok) {
                    const room = await response.json();
                    currentRoomId = room.id;
                    showStatus('roomStatus', `Ï±ÑÌåÖÎ∞© ÏÉùÏÑ± ÏÑ±Í≥µ: ${room.name}`, 'success');
                    log(`Ï±ÑÌåÖÎ∞© ÏÉùÏÑ± ÏÑ±Í≥µ: ${room.id}`, 'success');
                    
                    // ÏûêÎèô SSE Ïó∞Í≤∞
                    await connectSSE();
                    
                    // Ï±ÑÌåÖÎ∞© ÏûÖÏû•
                    enterRoom(room.id);
                    
                    // Ï±ÑÌåÖÎ∞© Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
                    loadChatRooms();
                } else {
                    const error = await response.text();
                    showStatus('roomStatus', `Ï±ÑÌåÖÎ∞© ÏÉùÏÑ± Ïã§Ìå®: ${response.status}`, 'error');
                    log(`Ï±ÑÌåÖÎ∞© ÏÉùÏÑ± Ïã§Ìå®: ${error}`, 'error');
                }
            } catch (error) {
                showStatus('roomStatus', 'Ï±ÑÌåÖÎ∞© ÏÉùÏÑ± Ï§ë Ïò§Î•ò Î∞úÏÉù', 'error');
                log(`Ï±ÑÌåÖÎ∞© ÏÉùÏÑ± Ïò§Î•ò: ${error.message}`, 'error');
            }
        }

        // Ï±ÑÌåÖÎ∞© ÏûÖÏû•
        async function enterRoom(roomId) {
            currentRoomId = roomId;
            log(`Ï±ÑÌåÖÎ∞© ÏûÖÏû•: ${roomId}`);
            
            // Î≤ÑÌçº Î∞è ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
            conversationBuffer = '';
            displayedVocabulary.clear();
            resetPendingResponses();
            hideLoadingMessage();
            
            // Ï±ÑÌåÖÎ∞© Ï†ïÎ≥¥ Í∞ÄÏ†∏ÏôÄÏÑú chatbotId ÏÑ§Ï†ï
            try {
                const response = await fetch(`/api/chat/chatrooms/${roomId}?userId=${currentUserId}`);
                if (response.ok) {
                    const room = await response.json();
                    currentChatbotId = room.chatbot?.id || room.chatbotId;
                    log(`Ï±óÎ¥á ID ÏÑ§Ï†ï: ${currentChatbotId}`);
                    
                    // Ï±ÑÌåÖÎ∞© Ï†ïÎ≥¥ ÌëúÏãú
                    document.getElementById('chatRoomInfo').classList.remove('hidden');
                    document.getElementById('currentRoomIdDisplay').textContent = roomId.substring(0, 8) + '...';
                    
                    // ÏπúÎ∞ÄÎèÑ Î†àÎ≤® ÌëúÏãú Ï∂îÍ∞Ä
                    if (room.intimacyLevel) {
                        document.getElementById('currentIntimacyLevel').value = room.intimacyLevel;
                    }
                }
            } catch (error) {
                log(`Ï±ÑÌåÖÎ∞© Ï†ïÎ≥¥ Ï°∞Ìöå Ïò§Î•ò: ${error.message}`, 'error');
            }
            
            // Ï±óÎ¥á Í¥ÄÎ¶¨ ÏÑπÏÖò ÌëúÏãú
            document.getElementById('chatbotManagement').classList.remove('hidden');
            
            // Ï±ÑÌåÖ Î©îÏãúÏßÄ Î°úÎìú
            loadMessages();
        }

        // Ï±ÑÌåÖÎ∞© Î™©Î°ù Î°úÎìú
        async function loadChatRooms() {
            if (!currentUserId) return;

            try {
                const response = await fetch(`/api/chat/chatrooms/all?userId=${currentUserId}`);
                if (response.ok) {
                    const rooms = await response.json();
                    const roomList = document.getElementById('roomList');
                    roomList.innerHTML = '';
                    
                    if (rooms.length === 0) {
                        roomList.innerHTML = '<div class="room-item">Ï±ÑÌåÖÎ∞©Ïù¥ ÏóÜÏäµÎãàÎã§.</div>';
            } else {
                        rooms.forEach(room => {
                            const roomItem = document.createElement('div');
                            roomItem.className = 'room-item';
                            roomItem.textContent = `${room.name} (${room.chatbotId ? 'Ï±óÎ¥á Ïó∞Í≤∞Îê®' : 'Ï±óÎ¥á ÏóÜÏùå'})`;
                            roomItem.onclick = () => enterRoom(room.id);
                            roomList.appendChild(roomItem);
                        });
                    }
                    log(`Ï±ÑÌåÖÎ∞© Î™©Î°ù Î°úÎìú: ${rooms.length}Í∞ú`, 'success');
                }
            } catch (error) {
                log(`Ï±ÑÌåÖÎ∞© Î™©Î°ù Î°úÎìú Ïò§Î•ò: ${error.message}`, 'error');
            }
        }

        // SSE Ïó∞Í≤∞
        async function connectSSE() {
            if (!currentUserId || !currentRoomId) {
                log('SSE Ïó∞Í≤∞ Ïã§Ìå®: ÏÇ¨Ïö©Ïûê ID ÎòêÎäî Ï±ÑÌåÖÎ∞© IDÍ∞Ä ÏóÜÏäµÎãàÎã§.', 'error');
                return;
            }
            
            if (eventSource) {
                eventSource.close();
            }

            try {
                const url = `/api/chat/stream/${currentRoomId}?userId=${currentUserId}`;
                log(`SSE Ïó∞Í≤∞ ÏãúÎèÑ: ${url}`);
                
                eventSource = new EventSource(url);
                
                eventSource.onopen = function() {
                    isConnected = true;
                    updateSSEStatus(true);
                    log('SSE Ïó∞Í≤∞ ÏÑ±Í≥µ', 'success');
                };
                
                // Í∞úÎ≥Ñ Ïù¥Î≤§Ìä∏ ÌÉÄÏûÖÎ≥Ñ Î¶¨Ïä§ÎÑà Îì±Î°ù
                eventSource.addEventListener('conversation_chunk', function(event) {
                    try {
                        // conversation_chunkÎäî ÏàúÏàò ÌÖçÏä§Ìä∏Î°ú Ï†ÑÏÜ°Îê®
                        const data = event.data;
                        log(`ÎåÄÌôî Ï≤≠ÌÅ¨ ÏàòÏã†: ${data}`, 'info');
                        
                        // Ï≤≠ÌÅ¨Î•º Î≤ÑÌçºÏóê Ï†ÄÏû•Îßå ÌïòÍ≥† ÌëúÏãúÌïòÏßÄ ÏïäÏùå
                        conversationBuffer += data;
                    } catch (e) {
                        log(`ÎåÄÌôî Ï≤≠ÌÅ¨ Ï≤òÎ¶¨ Ïò§Î•ò: ${e.message}`, 'error');
                    }
                });
                
                eventSource.addEventListener('conversation_complete', function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        log(`ÎåÄÌôî ÏôÑÎ£å: ${data.content}`, 'success');
                        
                        // data.contentÎ•º ÏÇ¨Ïö© (ÎùÑÏñ¥Ïì∞Í∏∞ Ï†ÅÏö©Îê®)
                        pendingResponses.conversation = data.content;
                        checkAndDisplayAllResponses();
                    } catch (e) {
                        log(`ÎåÄÌôî ÏôÑÎ£å ÌååÏã± Ïò§Î•ò: ${e.message}`, 'error');
                    }
                });
                
                eventSource.addEventListener('intimacy_analysis', function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        log(`ÏπúÎ∞ÄÎèÑ Î∂ÑÏÑù: ${data.feedback}`, 'info');
                        
                        pendingResponses.intimacy = {
                            feedback: data.feedback,
                            correctedSentence: data.correctedSentence
                        };
                        checkAndDisplayAllResponses();
                    } catch (e) {
                        log(`ÏπúÎ∞ÄÎèÑ Î∂ÑÏÑù ÌååÏã± Ïò§Î•ò: ${e.message}`, 'error');
                    }
                });
                
                eventSource.addEventListener('vocabulary_extracted', function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        log(`Ïñ¥Ìúò Ï∂îÏ∂ú: ${data.words?.length || 0}Í∞ú`, 'info');
                        
                        if (data.words && data.words.length > 0) {
                            const word = data.words[0];
                            const wordKey = `${currentRoomId}_${word.word}`;
                            
                            if (!displayedVocabulary.has(wordKey)) {
                                pendingResponses.vocabulary = { word: word.word };
                                displayedVocabulary.add(wordKey);
                            } else {
                                pendingResponses.vocabulary = {}; // Ï§ëÎ≥µÏù∏ Í≤ΩÏö∞ Îπà Í∞ùÏ≤¥
                            }
                        } else {
                            pendingResponses.vocabulary = {};
                        }
                        checkAndDisplayAllResponses();
                    } catch (e) {
                        log(`Ïñ¥Ìúò Ï∂îÏ∂ú ÌååÏã± Ïò§Î•ò: ${e.message}`, 'error');
                    }
                });
                
                eventSource.addEventListener('vocabulary_translated', function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        log(`Î≤àÏó≠ ÏôÑÎ£å: ${data.translations?.length || 0}Í∞ú`, 'info');
                        
                        if (data.translations && data.translations.length > 0) {
                            const trans = data.translations[0];
                            pendingResponses.translation = {
                                text: `${trans.original} ‚Üí ${trans.english} ${trans.pronunciation}`
                            };
                        } else {
                            pendingResponses.translation = {};
                        }
                        checkAndDisplayAllResponses();
                    } catch (e) {
                        log(`Î≤àÏó≠ ÏôÑÎ£å ÌååÏã± Ïò§Î•ò: ${e.message}`, 'error');
                    }
                });
                
                eventSource.addEventListener('aggregated_complete', function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        log(`Ï†ÑÏ≤¥ Ï≤òÎ¶¨ ÏôÑÎ£å`, 'success');
                    } catch (e) {
                        log(`Ï†ÑÏ≤¥ Ï≤òÎ¶¨ ÏôÑÎ£å ÌååÏã± Ïò§Î•ò: ${e.message}`, 'error');
                    }
                });
                
                eventSource.addEventListener('conversation_error', function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        addMessageToChat(`ÎåÄÌôî Ïò§Î•ò: ${data}`, 'system');
                        log(`ÎåÄÌôî Ïò§Î•ò: ${data}`, 'error');
                    } catch (e) {
                        log(`ÎåÄÌôî Ïò§Î•ò ÌååÏã± Ïò§Î•ò: ${e.message}`, 'error');
                    }
                });
                
                eventSource.addEventListener('agent_error', function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        addMessageToChat(`ÏóêÏù¥Ï†ÑÌä∏ Ïò§Î•ò: ${data}`, 'system');
                        log(`ÏóêÏù¥Ï†ÑÌä∏ Ïò§Î•ò: ${data}`, 'error');
                    } catch (e) {
                        log(`ÏóêÏù¥Ï†ÑÌä∏ Ïò§Î•ò ÌååÏã± Ïò§Î•ò: ${e.message}`, 'error');
                    }
                });
                
                // Í∏∞Î≥∏ Î©îÏãúÏßÄ Ï≤òÎ¶¨ (fallback)
                eventSource.onmessage = function(event) {
                    log(`Í∏∞Î≥∏ SSE Î©îÏãúÏßÄ: ${event.data}`, 'info');
                };
                
                eventSource.onerror = function(event) {
                    isConnected = false;
                    updateSSEStatus(false);
                    log('SSE Ïó∞Í≤∞ Ïò§Î•ò', 'error');
                };
                
            } catch (error) {
                log(`SSE Ïó∞Í≤∞ Ïò§Î•ò: ${error.message}`, 'error');
            }
        }

        // SSE Ïó∞Í≤∞ ÎÅäÍ∏∞
        function disconnectSSE() {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }
            isConnected = false;
            updateSSEStatus(false);
            log('SSE Ïó∞Í≤∞ ÎÅäÍπÄ', 'info');
        }

        // SSE ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
        function updateSSEStatus(connected) {
            const indicator = document.getElementById('sseIndicator');
            const statusText = document.getElementById('sseStatusText');
            
            if (connected) {
                indicator.className = 'status-indicator connected';
                statusText.textContent = 'Ïó∞Í≤∞Îê®';
            } else {
                indicator.className = 'status-indicator disconnected';
                statusText.textContent = 'Ïó∞Í≤∞ ÎÅäÍπÄ';
            }
        }

        // Î©îÏãúÏßÄ Ï†ÑÏÜ°
        async function sendMessage() {
            if (!currentUserId || !currentRoomId) {
                log('Î©îÏãúÏßÄ Ï†ÑÏÜ° Ïã§Ìå®: Î°úÍ∑∏Ïù∏ ÎòêÎäî Ï±ÑÌåÖÎ∞© ÏûÖÏû•Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.', 'error');
                return;
            }
            
            const messageInput = document.getElementById('messageInput');
            const content = messageInput.value.trim();
            
            if (!content) return;

            try {
                // ÏÇ¨Ïö©Ïûê Î©îÏãúÏßÄ ÌëúÏãú
                addMessageToChat(content, 'user');
                messageInput.value = '';
                
                // ÏùëÎãµ ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî Î∞è Î°úÎî© ÌëúÏãú
                resetPendingResponses();
                showLoadingMessage();
                
                const response = await fetch(`/api/chat/chatrooms/${currentRoomId}/messages?userId=${currentUserId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        content: content,
                        senderType: 'user',
                        contentType: 'text'
                    })
                });

                if (response.ok) {
                    const message = await response.json();
                    log(`Î©îÏãúÏßÄ Ï†ÑÏÜ° ÏÑ±Í≥µ: ${content}`, 'success');
                } else {
                    log(`Î©îÏãúÏßÄ Ï†ÑÏÜ° Ïã§Ìå®: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`Î©îÏãúÏßÄ Ï†ÑÏÜ° Ïò§Î•ò: ${error.message}`, 'error');
            }
        }

        // Ï±ÑÌåÖÏóê Î©îÏãúÏßÄ Ï∂îÍ∞Ä
        function addMessageToChat(content, type, isChunk = false) {
            const chatMessages = document.getElementById('chatMessages');
            
            if (isChunk && type === 'bot') {
                // Ï≤≠ÌÅ¨ Î©îÏãúÏßÄÏù∏ Í≤ΩÏö∞ Í∏∞Ï°¥ Î¥á Î©îÏãúÏßÄÏóê Ï∂îÍ∞Ä
                let lastMessage = chatMessages.lastElementChild;
                if (lastMessage && lastMessage.classList.contains('message') && lastMessage.classList.contains('bot')) {
                    lastMessage.textContent += content;
                } else {
                    // ÏÉàÎ°úÏö¥ Î¥á Î©îÏãúÏßÄ ÏÉùÏÑ±
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `message ${type}`;
                    messageDiv.textContent = content;
                    chatMessages.appendChild(messageDiv);
                }
            } else {
                // ÏùºÎ∞ò Î©îÏãúÏßÄ
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
                messageDiv.textContent = content;
            chatMessages.appendChild(messageDiv);
            }
            
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Î©îÏãúÏßÄ Î°úÎìú
        async function loadMessages() {
            if (!currentRoomId) return;

            try {
                const response = await fetch(`/api/chat/chatrooms/${currentRoomId}/messages?userId=${currentUserId}`);
                if (response.ok) {
                    const data = await response.json();
                    const messages = data.content || [];
                    
                    const chatMessages = document.getElementById('chatMessages');
                    chatMessages.innerHTML = '';
                    
                    messages.forEach(msg => {
                        addMessageToChat(msg.content, msg.senderType);
                    });
                    
                    log(`Î©îÏãúÏßÄ Î°úÎìú: ${messages.length}Í∞ú`, 'success');
                }
            } catch (error) {
                log(`Î©îÏãúÏßÄ Î°úÎìú Ïò§Î•ò: ${error.message}`, 'error');
            }
        }

        // ÌÇ§Î≥¥Îìú Ïù¥Î≤§Ìä∏ Ï≤òÎ¶¨
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // Ï±óÎ¥á ÌîÑÎ°¨ÌîÑÌä∏ Ï°∞Ìöå (Í∞úÏÑ†)
        async function loadChatbotPrompt() {
            if (!currentChatbotId) {
                showStatus('promptDisplay', 'Ï±ÑÌåÖÎ∞©Ïóê ÏûÖÏû•Ìï¥Ï£ºÏÑ∏Ïöî.', 'error');
                document.getElementById('basePromptText').value = '';
                return;
            }
            
            try {
                const agentType = document.getElementById('agentType').value;
                
                // ConversationÍ≥º IntimacyÎßå Dynamic Directives ÌëúÏãú
                const showDynamic = (agentType === 'conversation' || agentType === 'intimacy');
                document.getElementById('dynamicDirectivesSection').style.display = showDynamic ? 'block' : 'none';
                document.getElementById('fullPromptSection').style.display = showDynamic ? 'block' : 'none';
                
                let url = `/api/chat/chatbots/prompt/full?chatbotId=${currentChatbotId}&agentType=${agentType}`;
                if (currentRoomId) {
                    url += `&chatroomId=${currentRoomId}`;
                }
                
                const response = await fetch(url);
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.type === 'full') {
                        // Ï†ÑÏ≤¥ ÌîÑÎ°¨ÌîÑÌä∏ (Base + Dynamic)
                        document.getElementById('basePromptText').value = data.basePrompt || '';
                        
                        // Dynamic Directives Í≥ÑÏÇ∞ (fullPrompt - basePrompt)
                        const dynamicPart = data.fullPrompt.replace(data.basePrompt, '').trim();
                        document.getElementById('dynamicDirectivesText').value = dynamicPart || '(Dynamic Directives ÏóÜÏùå)';
                        document.getElementById('fullPromptText').value = data.fullPrompt || '';
                        
                        showStatus('promptDisplay', 
                            `‚úÖ ${data.message}\nüí° Base PromptÎßå ÏàòÏ†ï Í∞ÄÎä•ÌïòÎ©∞, Dynamic DirectivesÎäî ÏûêÎèôÏúºÎ°ú Ï∂îÍ∞ÄÎê©ÎãàÎã§.`, 
                            'success');
                    } else {
                        // BaseÎßå
                        document.getElementById('basePromptText').value = data.prompt || '';
                        document.getElementById('dynamicDirectivesText').value = '';
                        document.getElementById('fullPromptText').value = '';
                        showStatus('promptDisplay', data.message, 'info');
                    }
                    
                    log(`Ï±óÎ¥á ÌîÑÎ°¨ÌîÑÌä∏ Ï°∞Ìöå: ${agentType}`, 'success');
                } else {
                    showStatus('promptDisplay', 'ÌîÑÎ°¨ÌîÑÌä∏ Ï°∞Ìöå Ïã§Ìå®', 'error');
                    document.getElementById('basePromptText').value = '';
                }
            } catch (error) {
                showStatus('promptDisplay', 'ÌîÑÎ°¨ÌîÑÌä∏ Ï°∞Ìöå Ï§ë Ïò§Î•ò Î∞úÏÉù', 'error');
                log(`ÌîÑÎ°¨ÌîÑÌä∏ Ï°∞Ìöå Ïò§Î•ò: ${error.message}`, 'error');
                document.getElementById('basePromptText').value = '';
            }
        }

        // Ï±óÎ¥á ÌîÑÎ°¨ÌîÑÌä∏ ÏàòÏ†ï
        async function updateChatbotPrompt() {
            if (!currentChatbotId) {
                showStatus('promptDisplay', 'Ï±ÑÌåÖÎ∞©Ïóê ÏûÖÏû•Ìï¥Ï£ºÏÑ∏Ïöî.', 'error');
                return;
            }

            const newPrompt = document.getElementById('basePromptText').value.trim();
            if (!newPrompt) {
                showStatus('promptDisplay', 'Base PromptÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.', 'error');
                return;
            }

            try {
                const agentType = document.getElementById('agentType').value;
                const response = await fetch('/api/chat/chatbots/prompt', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        chatbotId: currentChatbotId,
                        agentType: agentType,
                        systemPrompt: newPrompt
                    })
                });

                if (response.ok) {
                    showStatus('promptDisplay', '‚úÖ Base Prompt ÏàòÏ†ï ÏÑ±Í≥µ!\nüîÑ Îã§Ïùå Î©îÏãúÏßÄÎ∂ÄÌÑ∞ ÏÉà ÌîÑÎ°¨ÌîÑÌä∏Í∞Ä Ï†ÅÏö©Îê©ÎãàÎã§.', 'success');
                    log(`Ï±óÎ¥á ÌîÑÎ°¨ÌîÑÌä∏ ÏàòÏ†ï: ${agentType}`, 'success');
                    
                    // ÏàòÏ†ï ÌõÑ ÏûêÎèô Ïû¨Ï°∞Ìöå
                    setTimeout(() => loadChatbotPrompt(), 500);
                } else {
                    showStatus('promptDisplay', 'ÌîÑÎ°¨ÌîÑÌä∏ ÏàòÏ†ï Ïã§Ìå®', 'error');
                }
            } catch (error) {
                showStatus('promptDisplay', 'ÌîÑÎ°¨ÌîÑÌä∏ ÏàòÏ†ï Ï§ë Ïò§Î•ò Î∞úÏÉù', 'error');
                log(`ÌîÑÎ°¨ÌîÑÌä∏ ÏàòÏ†ï Ïò§Î•ò: ${error.message}`, 'error');
            }
        }

        // Ï±óÎ¥á ÌîÑÎ°¨ÌîÑÌä∏ Î¶¨ÏÖã
        async function resetChatbotPrompt() {
            if (!currentChatbotId) {
                showStatus('promptDisplay', 'Ï±ÑÌåÖÎ∞©Ïóê ÏûÖÏû•Ìï¥Ï£ºÏÑ∏Ïöî.', 'error');
                return;
            }

            if (!confirm('ÌîÑÎ°¨ÌîÑÌä∏Î•º Í∏∞Î≥∏Í∞íÏúºÎ°ú Î¶¨ÏÖãÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                return;
            }

            try {
                const agentType = document.getElementById('agentType').value;
                const response = await fetch(`/api/chat/chatbots/reset?chatbotId=${currentChatbotId}&agentType=${agentType}`, {
                    method: 'POST'
                });

                if (response.ok) {
                    showStatus('promptDisplay', 'ÌîÑÎ°¨ÌîÑÌä∏ Î¶¨ÏÖã ÏÑ±Í≥µ', 'success');
                    log(`Ï±óÎ¥á ÌîÑÎ°¨ÌîÑÌä∏ Î¶¨ÏÖã: ${agentType}`, 'success');
                    // Î¶¨ÏÖã ÌõÑ ÏûêÎèôÏúºÎ°ú Ï°∞Ìöå
                    await loadChatbotPrompt();
                } else {
                    showStatus('promptDisplay', 'ÌîÑÎ°¨ÌîÑÌä∏ Î¶¨ÏÖã Ïã§Ìå®', 'error');
                }
            } catch (error) {
                showStatus('promptDisplay', 'ÌîÑÎ°¨ÌîÑÌä∏ Î¶¨ÏÖã Ï§ë Ïò§Î•ò Î∞úÏÉù', 'error');
                log(`ÌîÑÎ°¨ÌîÑÌä∏ Î¶¨ÏÖã Ïò§Î•ò: ${error.message}`, 'error');
            }
        }

        // Ï±ÑÌåÖÎ∞© ÎÇòÍ∞ÄÍ∏∞
        async function leaveChatRoom() {
            if (!currentRoomId) {
                log('Ï±ÑÌåÖÎ∞©Ïóê ÏûÖÏû•ÌïòÏßÄ ÏïäÏïòÏäµÎãàÎã§.', 'error');
                return;
            }
            
            if (!confirm('Ï±ÑÌåÖÎ∞©ÏùÑ ÎÇòÍ∞ÄÏãúÍ≤†ÏäµÎãàÍπå?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/chat/chatrooms/${currentRoomId}/leave?userId=${currentUserId}`, {
                    method: 'POST'
                });
                
                if (response.ok || response.status === 204) {
                    log('Ï±ÑÌåÖÎ∞© ÎÇòÍ∞ÄÍ∏∞ ÏÑ±Í≥µ', 'success');
                    
                    // SSE Ïó∞Í≤∞ Ìï¥Ï†ú
                    if (eventSource) {
                        disconnectSSE();
                    }
                    
                    // UI Ï¥àÍ∏∞Ìôî
                    currentRoomId = null;
                    currentChatbotId = null;
                    document.getElementById('chatMessages').innerHTML = '<div class="message system">Ï±ÑÌåÖÎ∞©Ïóê ÏûÖÏû•ÌïòÎ©¥ Ïó¨Í∏∞Ïóê Î©îÏãúÏßÄÍ∞Ä ÌëúÏãúÎê©ÎãàÎã§.</div>';
                    document.getElementById('chatbotManagement').classList.add('hidden');
                    document.getElementById('chatRoomInfo').classList.add('hidden');
                    document.getElementById('currentRoomIdDisplay').textContent = '-';
                    document.getElementById('promptText').value = '';
                    
                    // Ï±ÑÌåÖÎ∞© Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
                    loadChatRooms();
                } else {
                    log(`Ï±ÑÌåÖÎ∞© ÎÇòÍ∞ÄÍ∏∞ Ïã§Ìå®: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`Ï±ÑÌåÖÎ∞© ÎÇòÍ∞ÄÍ∏∞ Ïò§Î•ò: ${error.message}`, 'error');
            }
        }

        // ÏπúÎ∞ÄÎèÑ Î†àÎ≤® ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò
        async function updateIntimacyLevel() {
            if (!currentRoomId || !currentUserId) {
                log('ÏπúÎ∞ÄÎèÑ Î≥ÄÍ≤Ω Ïã§Ìå®: Ï±ÑÌåÖÎ∞©Ïóê ÏûÖÏû•Ìï¥Ï£ºÏÑ∏Ïöî.', 'error');
                return;
            }
            
            const newLevel = parseInt(document.getElementById('currentIntimacyLevel').value);
            
            try {
                const response = await fetch(`/api/chat/chatrooms/${currentRoomId}/intimacy`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ intimacyLevel: newLevel })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    log(`ÏπúÎ∞ÄÎèÑ Î≥ÄÍ≤Ω ÏÑ±Í≥µ: Î†àÎ≤® ${newLevel}`, 'success');
                    addMessageToChat(`üìä ÏπúÎ∞ÄÎèÑÍ∞Ä Î†àÎ≤® ${newLevel}Î°ú Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§.`, 'system');
                    
                    // ÌîÑÎ°¨ÌîÑÌä∏ ÏûêÎèô Ïû¨Ï°∞Ìöå (Dynamic Directives Î∞òÏòÅ)
                    if (currentChatbotId) {
                        await loadChatbotPrompt();
                    }
                } else {
                    log(`ÏπúÎ∞ÄÎèÑ Î≥ÄÍ≤Ω Ïã§Ìå®: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`ÏπúÎ∞ÄÎèÑ Î≥ÄÍ≤Ω Ïò§Î•ò: ${error.message}`, 'error');
            }
        }

        // Directives Î∂àÎü¨Ïò§Í∏∞
        async function loadDirectives() {
            let chatbotId = document.getElementById('directiveChatbotId').value.trim();
            
            // Ï±óÎ¥á IDÍ∞Ä ÎπÑÏñ¥ÏûàÏúºÎ©¥ ÌòÑÏû¨ Ï±ÑÌåÖÎ∞©Ïùò Ï±óÎ¥á ÏÇ¨Ïö©
            if (!chatbotId && currentChatbotId) {
                chatbotId = currentChatbotId;
                document.getElementById('directiveChatbotId').value = chatbotId;
            }
            
            if (!chatbotId) {
                showStatus('directiveStatus', 'Ï±óÎ¥á IDÎ•º ÏûÖÎ†•ÌïòÍ±∞ÎÇò Ï±ÑÌåÖÎ∞©ÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî', 'error');
                return;
            }
            
            try {
                log(`Directives Î°úÎìú ÏãúÎèÑ: ${chatbotId}`);
                const response = await fetch(`/api/chat/chatbots/${chatbotId}/directives`);
                
                if (response.ok) {
                    const data = await response.json();
                    const directives = data.directives;
                    
                    // Concept
                    if (directives.concept) {
                        document.getElementById('conceptEnabled').checked = directives.concept.enabled !== false;
                        document.getElementById('conceptCustom').value = directives.concept.custom || '';
                    }
                    
                    // Intimacy
                    if (directives.intimacy) {
                        document.getElementById('intimacyEnabled').checked = directives.intimacy.enabled !== false;
                        document.getElementById('intimacyCustom').value = directives.intimacy.custom || '';
                    }
                    
                    // Language
                    if (directives.language) {
                        document.getElementById('languageEnabled').checked = directives.language.enabled !== false;
                        document.getElementById('defaultLanguage').value = directives.language.default || 'ko';
                        document.getElementById('allowUserOverride').checked = directives.language.allowUserOverride !== false;
                    }
                    
                    showStatus('directiveStatus', 'Directives Î°úÎìú ÏôÑÎ£å', 'success');
                    log('Directives Î°úÎìú ÏÑ±Í≥µ', 'success');
                } else {
                    showStatus('directiveStatus', 'Directives Î°úÎìú Ïã§Ìå®', 'error');
                    log(`Directives Î°úÎìú Ïã§Ìå®: ${response.status}`, 'error');
                }
            } catch (error) {
                showStatus('directiveStatus', 'Ïò§Î•ò Î∞úÏÉù', 'error');
                log(`Directives Î°úÎìú Ïò§Î•ò: ${error.message}`, 'error');
            }
        }

        // Directives ÏóÖÎç∞Ïù¥Ìä∏
        async function updateDirectives() {
            const chatbotId = document.getElementById('directiveChatbotId').value.trim();
            
            if (!chatbotId) {
                showStatus('directiveStatus', 'Ï±óÎ¥á IDÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî', 'error');
                return;
            }
            
            const request = {
                concept: {
                    enabled: document.getElementById('conceptEnabled').checked,
                    custom: document.getElementById('conceptCustom').value.trim() || null
                },
                intimacy: {
                    enabled: document.getElementById('intimacyEnabled').checked,
                    custom: document.getElementById('intimacyCustom').value.trim() || null
                },
                language: {
                    enabled: document.getElementById('languageEnabled').checked,
                    defaultLang: document.getElementById('defaultLanguage').value,
                    allowUserOverride: document.getElementById('allowUserOverride').checked
                }
            };
            
            try {
                log(`Directives ÏóÖÎç∞Ïù¥Ìä∏ ÏãúÎèÑ: ${chatbotId}`, 'info');
                const response = await fetch(`/api/chat/chatbots/${chatbotId}/directives`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(request)
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showStatus('directiveStatus', 'Directives ÏóÖÎç∞Ïù¥Ìä∏ ÏÑ±Í≥µ!', 'success');
                    log('Directives ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å', 'success');
                    log(`ÏÑ§Ï†ï ÎÇ¥Ïö©: ${JSON.stringify(request, null, 2)}`, 'info');
                } else {
                    showStatus('directiveStatus', 'Directives ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®', 'error');
                    log(`Directives ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®: ${response.status}`, 'error');
                }
            } catch (error) {
                showStatus('directiveStatus', 'Ïò§Î•ò Î∞úÏÉù', 'error');
                log(`Directives ÏóÖÎç∞Ïù¥Ìä∏ Ïò§Î•ò: ${error.message}`, 'error');
            }
        }

        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ï¥àÍ∏∞Ìôî
        document.addEventListener('DOMContentLoaded', function() {
            log('ÌéòÏù¥ÏßÄ Î°úÎìú ÏôÑÎ£å', 'info');
        });
    </script>
</body>
</html>
