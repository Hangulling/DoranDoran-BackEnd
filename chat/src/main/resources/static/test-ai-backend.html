<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DoranDoran Chat Test - ê°œì„ ëœ UX</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .test-guide {
            background: rgba(255,255,255,0.1);
            margin-top: 15px;
            padding: 15px;
            border-radius: 10px;
            font-size: 0.9em;
        }
        
        .test-guide h4 {
            margin-bottom: 10px;
            color: #fff;
        }
        
        .test-guide ul {
            list-style: none;
            padding: 0;
        }
        
        .test-guide li {
            margin: 5px 0;
            padding-left: 20px;
            position: relative;
        }
        
        .test-guide li:before {
            content: "âœ“";
            position: absolute;
            left: 0;
            color: #4CAF50;
            font-weight: bold;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            padding: 30px;
        }
        
        .left-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .right-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #e1e8ed;
        }
        
        .section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.2em;
            border-bottom: 2px solid #3498db;
            padding-bottom: 5px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #34495e;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 5px rgba(52, 152, 219, 0.3);
        }
        
        .btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 5px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }
        
        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #27ae60, #229954);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }
        
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: 600;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .chat-container {
            background: white;
            border: 1px solid #e1e8ed;
            border-radius: 10px;
            height: 500px;
            display: flex;
            flex-direction: column;
        }
        
        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background: #f8f9fa;
        }
        
        .message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 15px;
            max-width: 80%;
            word-wrap: break-word;
        }
        
        .message.user {
            background: #3498db;
            color: white;
            margin-left: auto;
        }
        
        .message.bot {
            background: #ecf0f1;
            color: #2c3e50;
            margin-right: auto;
        }
        
        .message.system {
            background: #f39c12;
            color: white;
            text-align: center;
            margin: 0 auto;
            max-width: 100%;
        }
        
        .message.vocabulary {
            background: #e3f2fd;
            color: #1565c0;
            margin-right: auto;
            border-left: 3px solid #2196f3;
        }
        
        .message.translation {
            background: #f3e5f5;
            color: #6a1b9a;
            margin-right: auto;
            border-left: 3px solid #9c27b0;
        }
        
        .message.intimacy {
            background: #fff3e0;
            color: #e65100;
            margin-left: auto;
            border-left: 3px solid #ff9800;
        }
        
        .chat-input {
            padding: 15px;
            border-top: 1px solid #e1e8ed;
            display: flex;
            gap: 10px;
        }
        
        .chat-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 20px;
            outline: none;
        }
        
        .chat-input input:focus {
            border-color: #3498db;
        }
        
        .room-list {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .room-item {
            padding: 10px;
            border: 1px solid #e1e8ed;
            border-radius: 5px;
            margin-bottom: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .room-item:hover {
            background: #e8f4f8;
        }
        
        .room-item.active {
            background: #3498db;
            color: white;
        }
        
        .sse-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }
        
        .status-indicator.connected {
            background: #27ae60;
            box-shadow: 0 0 10px rgba(39, 174, 96, 0.5);
        }
        
        .status-indicator.disconnected {
            background: #e74c3c;
        }
        
        .log-container {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }
        
        .log-entry.error {
            color: #e74c3c;
        }
        
        .log-entry.success {
            color: #27ae60;
        }
        
        .log-entry.info {
            color: #3498db;
        }
        
        .hidden {
            display: none;
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .full-width {
            grid-column: 1 / -1;
        }
        
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            resize: vertical;
            min-height: 150px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤– DoranDoran Chat Test</h1>
            <p>ê°œì„ ëœ UX - ì´ë©”ì¼ ê¸°ë°˜ ë¡œê·¸ì¸ & ìë™ SSE ì—°ê²°</p>
            <div class="test-guide">
                <h4>ğŸ“‹ í…ŒìŠ¤íŠ¸ ê°€ì´ë“œ</h4>
                <ul>
                    <li>ì´ë©”ì¼ë¡œ ë¡œê·¸ì¸ (test1@example.com ~ test10@example.com)</li>
                    <li>ì»¨ì…‰ê³¼ ì¹œë°€ë„ ì„ íƒ í›„ ì±„íŒ…ë°© ìƒì„±</li>
                    <li>ìë™ SSE ì—°ê²° ë° ì±„íŒ… ì‹œì‘</li>
                    <li>ì±—ë´‡ í”„ë¡¬í”„íŠ¸ ì¡°íšŒ/ìˆ˜ì • ê°€ëŠ¥</li>
                </ul>
            </div>
                </div>
                
        <div class="main-content">
            <!-- ì™¼ìª½ íŒ¨ë„ -->
            <div class="left-panel">
                <!-- ì‚¬ìš©ì ë¡œê·¸ì¸ ì„¹ì…˜ -->
                <div class="section">
                    <h3>ğŸ” ì‚¬ìš©ì ë¡œê·¸ì¸</h3>
                    <div class="form-group">
                        <label for="userEmail">ì´ë©”ì¼ ì£¼ì†Œ</label>
                        <input type="email" id="userEmail" placeholder="test1@example.com" value="test1@example.com">
                    </div>
                    <button class="btn" onclick="loginWithEmail()">ë¡œê·¸ì¸</button>
                    <div id="loginStatus" class="status hidden"></div>
            </div>
            
                <!-- ì±„íŒ…ë°© ìƒì„± ì„¹ì…˜ -->
                <div class="section">
                    <h3>ğŸ  ì±„íŒ…ë°© ìƒì„±</h3>
                    <div class="form-group">
                        <label for="roomName">ì±„íŒ…ë°© ì´ë¦„</label>
                        <input type="text" id="roomName" placeholder="í…ŒìŠ¤íŠ¸ ì±„íŒ…ë°©" value="í…ŒìŠ¤íŠ¸ ì±„íŒ…ë°©">
                </div>
                    <div class="form-group">
                        <label for="concept">ì»¨ì…‰</label>
                        <select id="concept">
                            <option value="FRIEND">ì¹œêµ¬</option>
                            <option value="HONEY">ê¿€</option>
                            <option value="COWORKER">ë™ë£Œ</option>
                            <option value="SENIOR">ì„ ë°°</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="intimacyLevel">ì¹œë°€ë„ ë ˆë²¨</label>
                        <select id="intimacyLevel">
                            <option value="1">1 - ê²©ì‹ì²´/ì¡´ëŒ“ë§</option>
                            <option value="2" selected>2 - ë¶€ë“œëŸ¬ìš´ ì¡´ëŒ“ë§</option>
                            <option value="3">3 - ì¹œê·¼í•œ ë°˜ë§</option>
                        </select>
                    </div>
                    <button class="btn btn-success" onclick="createAndEnterRoom()">ì±„íŒ…ë°© ìƒì„± & ì…ì¥</button>
                    <div id="roomStatus" class="status hidden"></div>
                    </div>
                    
                <!-- ì±„íŒ…ë°© ëª©ë¡ ì„¹ì…˜ -->
                <div class="section">
                    <h3>ğŸ“‹ ì±„íŒ…ë°© ëª©ë¡</h3>
                    <button class="btn" onclick="loadChatRooms()">ëª©ë¡ ìƒˆë¡œê³ ì¹¨</button>
                    <div id="roomList" class="room-list"></div>
                    </div>
                
                <!-- SSE ì—°ê²° ìƒíƒœ ì„¹ì…˜ -->
                <div class="section">
                    <h3>ğŸ”— SSE ì—°ê²° ìƒíƒœ</h3>
                    <div class="sse-status">
                        <span class="status-indicator disconnected" id="sseIndicator"></span>
                        <span id="sseStatusText">ì—°ê²° ëŠê¹€</span>
                    </div>
                    <button class="btn" onclick="connectSSE()" id="connectBtn">SSE ì—°ê²°</button>
                    <button class="btn btn-danger" onclick="disconnectSSE()" id="disconnectBtn">ì—°ê²° ëŠê¸°</button>
                </div>
                </div>

            <!-- ì˜¤ë¥¸ìª½ íŒ¨ë„ -->
            <div class="right-panel">
                <!-- ì±„íŒ…ë°© ì •ë³´ ë° ë‚˜ê°€ê¸° (ì±„íŒ…ë°© ì…ì¥ í›„ì—ë§Œ í‘œì‹œ) -->
                <div class="section hidden" id="chatRoomInfo">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h3>ğŸ’¬ ì±„íŒ…ë°©</h3>
                        <button class="btn btn-danger" onclick="leaveChatRoom()" style="margin: 0;">ë‚˜ê°€ê¸°</button>
                    </div>
                    <div id="roomInfoDisplay" style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                        <p style="margin: 5px 0;"><strong>ì±„íŒ…ë°© ID:</strong> <span id="currentRoomIdDisplay">-</span></p>
                    </div>
                    
                    <!-- ì¹œë°€ë„ ë³€ê²½ UI -->
                    <div class="form-group" style="margin-top: 15px;">
                        <label for="currentIntimacyLevel">í˜„ì¬ ì¹œë°€ë„ ë ˆë²¨</label>
                        <select id="currentIntimacyLevel">
                            <option value="1">1 - ê²©ì‹ì²´/ì¡´ëŒ“ë§</option>
                            <option value="2">2 - ë¶€ë“œëŸ¬ìš´ ì¡´ëŒ“ë§</option>
                            <option value="3">3 - ì¹œê·¼í•œ ë°˜ë§</option>
                        </select>
                        <button class="btn btn-warning" onclick="updateIntimacyLevel()" style="margin-top: 10px;">ì¹œë°€ë„ ë³€ê²½</button>
                    </div>
                </div>
                
                <!-- ì±„íŒ… ì¸í„°í˜ì´ìŠ¤ -->
                <div class="section">
                    <h3>ğŸ’¬ ì±„íŒ…</h3>
                    <div class="chat-container">
                        <div id="chatMessages" class="chat-messages">
                            <div class="message system">ì±„íŒ…ë°©ì— ì…ì¥í•˜ë©´ ì—¬ê¸°ì— ë©”ì‹œì§€ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>
                    </div>
                <div class="chat-input">
                            <input type="text" id="messageInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." onkeypress="handleKeyPress(event)">
                        <button class="btn" onclick="sendMessage()">ì „ì†¡</button>
                    </div>
                    </div>
                </div>
                
                <!-- ì±—ë´‡ ê´€ë¦¬ ì„¹ì…˜ (ì±„íŒ…ë°© ì…ì¥ í›„ì—ë§Œ í‘œì‹œ) -->
                <div class="section hidden" id="chatbotManagement">
                    <h3>ğŸ¤– ì±—ë´‡ ê´€ë¦¬</h3>
                    <div class="form-group">
                        <label for="agentType">ì—ì´ì „íŠ¸ íƒ€ì…</label>
                        <select id="agentType" onchange="loadChatbotPrompt()">
                            <option value="conversation">ëŒ€í™” (ConversationAgent)</option>
                            <option value="intimacy">ì¹œë°€ë„ ë¶„ì„ (IntimacyAgent)</option>
                            <option value="vocabulary">ì–´íœ˜ ì¶”ì¶œ (VocabularyAgent)</option>
                            <option value="translation">ë²ˆì—­ (TranslationAgent)</option>
                        </select>
                    </div>
                    
                    <!-- Base Prompt (ìˆ˜ì • ê°€ëŠ¥) -->
                    <div class="form-group">
                        <label for="basePromptText">
                            ğŸ“ Base Prompt (ìˆ˜ì • ê°€ëŠ¥)
                            <span style="font-size: 0.9em; color: #666; font-weight: normal;">
                                - ê¸°ë³¸ ì§€ì‹œì‚¬í•­ì„ ì‘ì„±í•˜ì„¸ìš”
                            </span>
                        </label>
                        <textarea id="basePromptText" rows="8" placeholder="Base Promptë¥¼ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                    </div>
                    
                    <!-- Dynamic Directives (ì½ê¸° ì „ìš©) -->
                    <div class="form-group" id="dynamicDirectivesSection" style="display: none;">
                        <label for="dynamicDirectivesText">
                            ğŸ”„ Dynamic Directives (ìë™ ìƒì„±, ì½ê¸° ì „ìš©)
                            <span style="font-size: 0.9em; color: #666; font-weight: normal;">
                                - Conceptì™€ Intimacy Levelì— ë”°ë¼ ìë™ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤
                            </span>
                        </label>
                        <textarea id="dynamicDirectivesText" rows="6" readonly 
                            style="background: #f0f0f0; cursor: not-allowed;" 
                            placeholder="ì±„íŒ…ë°© ì…ì¥ í›„ ìë™ ìƒì„±ë©ë‹ˆë‹¤..."></textarea>
                    </div>
                    
                    <!-- ì „ì²´ í”„ë¡¬í”„íŠ¸ ë¯¸ë¦¬ë³´ê¸° -->
                    <div class="form-group" id="fullPromptSection" style="display: none;">
                        <label for="fullPromptText">
                            ğŸ‘ï¸ ì „ì²´ í”„ë¡¬í”„íŠ¸ ë¯¸ë¦¬ë³´ê¸° (ì‹¤ì œ AIì— ì „ë‹¬ë˜ëŠ” í”„ë¡¬í”„íŠ¸)
                        </label>
                        <textarea id="fullPromptText" rows="12" readonly 
                            style="background: #f9f9f9; border: 2px solid #3498db; cursor: default;" 
                            placeholder="ì±„íŒ…ë°© ì…ì¥ í›„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤..."></textarea>
                    </div>
                    
                    <div class="grid-2">
                        <button class="btn" onclick="loadChatbotPrompt()">í”„ë¡¬í”„íŠ¸ ì¡°íšŒ</button>
                        <button class="btn btn-warning" onclick="updateChatbotPrompt()">Base Prompt ìˆ˜ì •</button>
                        <button class="btn btn-danger full-width" onclick="resetChatbotPrompt()">ê¸°ë³¸ê°’ìœ¼ë¡œ ë¦¬ì…‹</button>
                    </div>
                    <div id="promptDisplay" class="status hidden"></div>
            </div>

                <!-- Directives ì„¤ì • íŒ¨ë„ (ê°œë°œììš©) -->
                <div class="section">
                    <h3>âš™ï¸ Directives ì„¤ì • (ê°œë°œììš©)</h3>
                    
                    <div style="margin-bottom: 15px;">
                        <label>í˜„ì¬ ì±—ë´‡ ID:</label>
                        <input type="text" id="directiveChatbotId" 
                               placeholder="ì±—ë´‡ ID ì…ë ¥ ë˜ëŠ” ìë™" 
                               style="width: 100%; padding: 8px; margin-top: 5px;">
                        <button onclick="loadDirectives()" 
                                style="width: 100%; margin-top: 5px; padding: 10px; background: #4facfe; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            í˜„ì¬ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
                        </button>
                    </div>
                    
                    <!-- Concept Directive -->
                    <div style="background: white; padding: 15px; border-radius: 5px; margin-bottom: 10px;">
                        <h4 style="margin-bottom: 10px;">Concept Directive</h4>
                        <label>
                            <input type="checkbox" id="conceptEnabled" checked>
                            í™œì„±í™”
                        </label>
                        <textarea id="conceptCustom" 
                                  placeholder="ì»¤ìŠ¤í…€ ì»¨ì…‰ ì§€ì¹¨ (ë¹„ì–´ìˆìœ¼ë©´ ê¸°ë³¸ í•˜ë“œì½”ë”© ì‚¬ìš©)"
                                  style="width: 100%; margin-top: 10px; padding: 8px; min-height: 60px; border-radius: 5px; border: 1px solid #ddd;"></textarea>
                    </div>
                    
                    <!-- Intimacy Directive -->
                    <div style="background: white; padding: 15px; border-radius: 5px; margin-bottom: 10px;">
                        <h4 style="margin-bottom: 10px;">Intimacy Directive</h4>
                        <label>
                            <input type="checkbox" id="intimacyEnabled" checked>
                            í™œì„±í™”
                        </label>
                        <textarea id="intimacyCustom" 
                                  placeholder="ì»¤ìŠ¤í…€ ì¹œë°€ë„ ì§€ì¹¨ (ë¹„ì–´ìˆìœ¼ë©´ ê¸°ë³¸ í•˜ë“œì½”ë”© ì‚¬ìš©)"
                                  style="width: 100%; margin-top: 10px; padding: 8px; min-height: 60px; border-radius: 5px; border: 1px solid #ddd;"></textarea>
                    </div>
                    
                    <!-- Language Directive -->
                    <div style="background: white; padding: 15px; border-radius: 5px; margin-bottom: 10px;">
                        <h4 style="margin-bottom: 10px;">Language Directive</h4>
                        <label>
                            <input type="checkbox" id="languageEnabled" checked>
                            í™œì„±í™”
                        </label>
                        <div style="margin-top: 10px;">
                            <label>ê¸°ë³¸ ì–¸ì–´:</label>
                            <select id="defaultLanguage" 
                                    style="width: 100%; padding: 8px; margin-top: 5px; border-radius: 5px;">
                                <option value="ko">í•œêµ­ì–´</option>
                                <option value="en">ì˜ì–´</option>
                                <option value="ja">ì¼ë³¸ì–´</option>
                                <option value="zh">ì¤‘êµ­ì–´</option>
                                <option value="fr">í”„ë‘ìŠ¤ì–´</option>
                                <option value="de">ë…ì¼ì–´</option>
                                <option value="es">ìŠ¤í˜ì¸ì–´</option>
                            </select>
                        </div>
                        <label style="margin-top: 10px; display: block;">
                            <input type="checkbox" id="allowUserOverride" checked>
                            ì‚¬ìš©ì ì–¸ì–´ ì˜¤ë²„ë¼ì´ë“œ í—ˆìš©
                        </label>
                    </div>
                    
                    <button onclick="updateDirectives()" 
                            style="width: 100%; padding: 12px; background: #43a047; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 1em; font-weight: bold;">
                        Directives ì ìš©
                    </button>
                    
                    <div id="directiveStatus" class="status hidden" style="margin-top: 10px;"></div>
                </div>

        <!-- ë¡œê·¸ ì„¹ì…˜ -->
                <div class="section">
                    <h3>ğŸ“Š ë¡œê·¸</h3>
                    <button class="btn" onclick="clearLogs()">ë¡œê·¸ ì§€ìš°ê¸°</button>
                    <div id="logContainer" class="log-container">
                        <div class="log-entry info">ì‹œìŠ¤í…œì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.</div>
                </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let currentUserId = null;
        let currentRoomId = null;
        let currentChatbotId = null;  // í˜„ì¬ ì±„íŒ…ë°©ì˜ ì±—ë´‡ ID
        let eventSource = null;
        let isConnected = false;
        let conversationBuffer = '';  // ëŒ€í™” ì²­í¬ ë²„í¼
        let displayedVocabulary = new Set();  // ì¤‘ë³µ ë°©ì§€ìš©
        let pendingResponses = {
            intimacy: null,
            vocabulary: null,
            translation: null,
            conversation: null
        };
        let isLoadingResponse = false;

        // ë¡œê·¸ í•¨ìˆ˜
        function log(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // ë¡œë”© UI í•¨ìˆ˜
        function showLoadingMessage() {
            const chatMessages = document.getElementById('chatMessages');
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'ai-loading';
            loadingDiv.className = 'message bot';
            loadingDiv.style.fontStyle = 'italic';
            loadingDiv.style.opacity = '0.7';
            loadingDiv.textContent = 'AIê°€ ë‹µë³€ì„ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤...';
            chatMessages.appendChild(loadingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            isLoadingResponse = true;
        }

        function hideLoadingMessage() {
            const loadingDiv = document.getElementById('ai-loading');
            if (loadingDiv) {
                loadingDiv.remove();
            }
            isLoadingResponse = false;
        }

        function clearLogs() {
            document.getElementById('logContainer').innerHTML = '<div class="log-entry info">ë¡œê·¸ê°€ ì§€ì›Œì¡ŒìŠµë‹ˆë‹¤.</div>';
        }

        // ì‘ë‹µ ê´€ë¦¬ í•¨ìˆ˜
        function checkAndDisplayAllResponses() {
            // ëª¨ë“  Agentê°€ ì‘ë‹µí–ˆëŠ”ì§€ í™•ì¸
            if (pendingResponses.intimacy !== null && 
                pendingResponses.vocabulary !== null && 
                pendingResponses.translation !== null && 
                pendingResponses.conversation !== null) {
                
                hideLoadingMessage();
                
                // ìˆœì„œëŒ€ë¡œ í‘œì‹œ
                // 1. Intimacy í”¼ë“œë°± (êµì • í¬í•¨)
                if (pendingResponses.intimacy.feedback) {
                    let message = `ğŸ“Š ${pendingResponses.intimacy.feedback}`;
                    if (pendingResponses.intimacy.correctedSentence) {
                        message += `\nâœï¸ êµì •ëœ ë¬¸ì¥: ${pendingResponses.intimacy.correctedSentence}`;
                    }
                    addMessageToChat(message, 'intimacy', false);
                }
                
                // 2. ë´‡ ì‘ë‹µ
                addMessageToChat(pendingResponses.conversation, 'bot', false);
                
                // 3. Vocabulary
                if (pendingResponses.vocabulary.word) {
                    const message = `ğŸ’¡ ìƒˆë¡œìš´ í‘œí˜„: ${pendingResponses.vocabulary.word}`;
                    addMessageToChat(message, 'vocabulary', false);
                }
                
                // 4. Translation
                if (pendingResponses.translation.text) {
                    addMessageToChat(pendingResponses.translation.text, 'translation', false);
                }
                
                // ì´ˆê¸°í™”
                resetPendingResponses();
            }
        }

        function resetPendingResponses() {
            pendingResponses = {
                intimacy: null,
                vocabulary: null,
                translation: null,
                conversation: null
            };
        }

        // ìƒíƒœ í‘œì‹œ í•¨ìˆ˜
        function showStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status ${type}`;
            element.classList.remove('hidden');
        }

        // ì´ë©”ì¼ë¡œ ë¡œê·¸ì¸
        async function loginWithEmail() {
            const email = document.getElementById('userEmail').value.trim();
            if (!email) {
                showStatus('loginStatus', 'ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            try {
                log(`ì´ë©”ì¼ë¡œ ë¡œê·¸ì¸ ì‹œë„: ${email}`);
                const response = await fetch(`/api/chat/users/by-email?email=${encodeURIComponent(email)}`);
                
                if (response.ok) {
                    const user = await response.json();
                    currentUserId = user.id;
                    showStatus('loginStatus', `ë¡œê·¸ì¸ ì„±ê³µ: ${user.name} (${user.email})`, 'success');
                    log(`ë¡œê·¸ì¸ ì„±ê³µ: ${user.name} (${user.id})`, 'success');
                    
                    // ì±„íŒ…ë°© ëª©ë¡ ë¡œë“œ
                    loadChatRooms();
                } else if (response.status === 404) {
                    showStatus('loginStatus', 'ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                    log(`ì‚¬ìš©ì ì—†ìŒ: ${email}`, 'error');
                } else {
                    showStatus('loginStatus', 'ë¡œê·¸ì¸ ì‹¤íŒ¨', 'error');
                    log(`ë¡œê·¸ì¸ ì‹¤íŒ¨: ${response.status}`, 'error');
                }
            } catch (error) {
                showStatus('loginStatus', 'ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ', 'error');
                log(`ë¡œê·¸ì¸ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }

        // ì±„íŒ…ë°© ìƒì„± ë° ì…ì¥
        async function createAndEnterRoom() {
            if (!currentUserId) {
                showStatus('roomStatus', 'ë¨¼ì € ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            const roomName = document.getElementById('roomName').value.trim();
            const concept = document.getElementById('concept').value;
            const intimacyLevel = parseInt(document.getElementById('intimacyLevel').value);

            if (!roomName) {
                showStatus('roomStatus', 'ì±„íŒ…ë°© ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            try {
                log(`ì±„íŒ…ë°© ìƒì„± ì‹œë„: ${roomName} (${concept}, ë ˆë²¨ ${intimacyLevel})`);
                
                // conceptë³„ ì±—ë´‡ UUID ë§¤í•‘
                const chatbotIdMap = {
                    'FRIEND': '22222222-2222-2222-2222-222222222221',
                    'HONEY': '22222222-2222-2222-2222-222222222222',
                    'COWORKER': '22222222-2222-2222-2222-222222222223',
                    'SENIOR': '22222222-2222-2222-2222-222222222224'
                };
                
                const chatbotId = chatbotIdMap[concept];
                
                const response = await fetch('/api/chat/chatrooms', {
                    method: 'POST',
                    headers: {
                    'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: currentUserId,
                        chatbotId: chatbotId,
                        name: roomName,
                        concept: concept,
                        intimacyLevel: intimacyLevel
                    })
                });

                if (response.ok) {
                    const room = await response.json();
                    currentRoomId = room.id;
                    showStatus('roomStatus', `ì±„íŒ…ë°© ìƒì„± ì„±ê³µ: ${room.name}`, 'success');
                    log(`ì±„íŒ…ë°© ìƒì„± ì„±ê³µ: ${room.id}`, 'success');
                    
                    // ìë™ SSE ì—°ê²°
                    await connectSSE();
                    
                    // ì±„íŒ…ë°© ì…ì¥
                    enterRoom(room.id);
                    
                    // ì±„íŒ…ë°© ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    loadChatRooms();
                } else {
                    const error = await response.text();
                    showStatus('roomStatus', `ì±„íŒ…ë°© ìƒì„± ì‹¤íŒ¨: ${response.status}`, 'error');
                    log(`ì±„íŒ…ë°© ìƒì„± ì‹¤íŒ¨: ${error}`, 'error');
                }
            } catch (error) {
                showStatus('roomStatus', 'ì±„íŒ…ë°© ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ', 'error');
                log(`ì±„íŒ…ë°© ìƒì„± ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }

        // ì±„íŒ…ë°© ì…ì¥
        async function enterRoom(roomId) {
            currentRoomId = roomId;
            log(`ì±„íŒ…ë°© ì…ì¥: ${roomId}`);
            
            // ë²„í¼ ë° ìƒíƒœ ì´ˆê¸°í™”
            conversationBuffer = '';
            displayedVocabulary.clear();
            resetPendingResponses();
            hideLoadingMessage();
            
            // ì±„íŒ…ë°© ì •ë³´ ê°€ì ¸ì™€ì„œ chatbotId ì„¤ì •
            try {
                const response = await fetch(`/api/chat/chatrooms/${roomId}?userId=${currentUserId}`);
                if (response.ok) {
                    const room = await response.json();
                    currentChatbotId = room.chatbot?.id || room.chatbotId;
                    log(`ì±—ë´‡ ID ì„¤ì •: ${currentChatbotId}`);
                    
                    // ì±„íŒ…ë°© ì •ë³´ í‘œì‹œ
                    document.getElementById('chatRoomInfo').classList.remove('hidden');
                    document.getElementById('currentRoomIdDisplay').textContent = roomId.substring(0, 8) + '...';
                    
                    // ì¹œë°€ë„ ë ˆë²¨ í‘œì‹œ ì¶”ê°€
                    if (room.intimacyLevel) {
                        document.getElementById('currentIntimacyLevel').value = room.intimacyLevel;
                    }
                }
            } catch (error) {
                log(`ì±„íŒ…ë°© ì •ë³´ ì¡°íšŒ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
            
            // ì±—ë´‡ ê´€ë¦¬ ì„¹ì…˜ í‘œì‹œ
            document.getElementById('chatbotManagement').classList.remove('hidden');
            
            // ì±„íŒ… ë©”ì‹œì§€ ë¡œë“œ
            loadMessages();
        }

        // ì±„íŒ…ë°© ëª©ë¡ ë¡œë“œ
        async function loadChatRooms() {
            if (!currentUserId) return;

            try {
                const response = await fetch(`/api/chat/chatrooms/all?userId=${currentUserId}`);
                if (response.ok) {
                    const rooms = await response.json();
                    const roomList = document.getElementById('roomList');
                    roomList.innerHTML = '';
                    
                    if (rooms.length === 0) {
                        roomList.innerHTML = '<div class="room-item">ì±„íŒ…ë°©ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            } else {
                        rooms.forEach(room => {
                            const roomItem = document.createElement('div');
                            roomItem.className = 'room-item';
                            roomItem.textContent = `${room.name} (${room.chatbotId ? 'ì±—ë´‡ ì—°ê²°ë¨' : 'ì±—ë´‡ ì—†ìŒ'})`;
                            roomItem.onclick = () => enterRoom(room.id);
                            roomList.appendChild(roomItem);
                        });
                    }
                    log(`ì±„íŒ…ë°© ëª©ë¡ ë¡œë“œ: ${rooms.length}ê°œ`, 'success');
                }
            } catch (error) {
                log(`ì±„íŒ…ë°© ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }

        // SSE ì—°ê²°
        async function connectSSE() {
            if (!currentUserId || !currentRoomId) {
                log('SSE ì—°ê²° ì‹¤íŒ¨: ì‚¬ìš©ì ID ë˜ëŠ” ì±„íŒ…ë°© IDê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }
            
            if (eventSource) {
                eventSource.close();
            }

            try {
                const url = `/api/chat/stream/${currentRoomId}?userId=${currentUserId}`;
                log(`SSE ì—°ê²° ì‹œë„: ${url}`);
                
                eventSource = new EventSource(url);
                
                eventSource.onopen = function() {
                    isConnected = true;
                    updateSSEStatus(true);
                    log('SSE ì—°ê²° ì„±ê³µ', 'success');
                };
                
                // ê°œë³„ ì´ë²¤íŠ¸ íƒ€ì…ë³„ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
                eventSource.addEventListener('conversation_chunk', function(event) {
                    try {
                        // conversation_chunkëŠ” ìˆœìˆ˜ í…ìŠ¤íŠ¸ë¡œ ì „ì†¡ë¨
                        const data = event.data;
                        log(`ëŒ€í™” ì²­í¬ ìˆ˜ì‹ : ${data}`, 'info');
                        
                        // ì²­í¬ë¥¼ ë²„í¼ì— ì €ì¥ë§Œ í•˜ê³  í‘œì‹œí•˜ì§€ ì•ŠìŒ
                        conversationBuffer += data;
                    } catch (e) {
                        log(`ëŒ€í™” ì²­í¬ ì²˜ë¦¬ ì˜¤ë¥˜: ${e.message}`, 'error');
                    }
                });
                
                eventSource.addEventListener('conversation_complete', function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        log(`ëŒ€í™” ì™„ë£Œ: ${data.content}`, 'success');
                        
                        // data.contentë¥¼ ì‚¬ìš© (ë„ì–´ì“°ê¸° ì ìš©ë¨)
                        pendingResponses.conversation = data.content;
                        checkAndDisplayAllResponses();
                    } catch (e) {
                        log(`ëŒ€í™” ì™„ë£Œ íŒŒì‹± ì˜¤ë¥˜: ${e.message}`, 'error');
                    }
                });
                
                eventSource.addEventListener('intimacy_analysis', function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        log(`ì¹œë°€ë„ ë¶„ì„: ${data.feedback}`, 'info');
                        
                        pendingResponses.intimacy = {
                            feedback: data.feedback,
                            correctedSentence: data.correctedSentence
                        };
                        checkAndDisplayAllResponses();
                    } catch (e) {
                        log(`ì¹œë°€ë„ ë¶„ì„ íŒŒì‹± ì˜¤ë¥˜: ${e.message}`, 'error');
                    }
                });
                
                eventSource.addEventListener('vocabulary_extracted', function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        log(`ì–´íœ˜ ì¶”ì¶œ: ${data.words?.length || 0}ê°œ`, 'info');
                        
                        if (data.words && data.words.length > 0) {
                            const word = data.words[0];
                            const wordKey = `${currentRoomId}_${word.word}`;
                            
                            if (!displayedVocabulary.has(wordKey)) {
                                pendingResponses.vocabulary = { word: word.word };
                                displayedVocabulary.add(wordKey);
                            } else {
                                pendingResponses.vocabulary = {}; // ì¤‘ë³µì¸ ê²½ìš° ë¹ˆ ê°ì²´
                            }
                        } else {
                            pendingResponses.vocabulary = {};
                        }
                        checkAndDisplayAllResponses();
                    } catch (e) {
                        log(`ì–´íœ˜ ì¶”ì¶œ íŒŒì‹± ì˜¤ë¥˜: ${e.message}`, 'error');
                    }
                });
                
                eventSource.addEventListener('vocabulary_translated', function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        log(`ë²ˆì—­ ì™„ë£Œ: ${data.translations?.length || 0}ê°œ`, 'info');
                        
                        if (data.translations && data.translations.length > 0) {
                            const trans = data.translations[0];
                            pendingResponses.translation = {
                                text: `${trans.original} â†’ ${trans.english} ${trans.pronunciation}`
                            };
                        } else {
                            pendingResponses.translation = {};
                        }
                        checkAndDisplayAllResponses();
                    } catch (e) {
                        log(`ë²ˆì—­ ì™„ë£Œ íŒŒì‹± ì˜¤ë¥˜: ${e.message}`, 'error');
                    }
                });
                
                eventSource.addEventListener('aggregated_complete', function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        log(`ì „ì²´ ì²˜ë¦¬ ì™„ë£Œ`, 'success');
                    } catch (e) {
                        log(`ì „ì²´ ì²˜ë¦¬ ì™„ë£Œ íŒŒì‹± ì˜¤ë¥˜: ${e.message}`, 'error');
                    }
                });
                
                eventSource.addEventListener('conversation_error', function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        addMessageToChat(`ëŒ€í™” ì˜¤ë¥˜: ${data}`, 'system');
                        log(`ëŒ€í™” ì˜¤ë¥˜: ${data}`, 'error');
                    } catch (e) {
                        log(`ëŒ€í™” ì˜¤ë¥˜ íŒŒì‹± ì˜¤ë¥˜: ${e.message}`, 'error');
                    }
                });
                
                eventSource.addEventListener('agent_error', function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        addMessageToChat(`ì—ì´ì „íŠ¸ ì˜¤ë¥˜: ${data}`, 'system');
                        log(`ì—ì´ì „íŠ¸ ì˜¤ë¥˜: ${data}`, 'error');
                    } catch (e) {
                        log(`ì—ì´ì „íŠ¸ ì˜¤ë¥˜ íŒŒì‹± ì˜¤ë¥˜: ${e.message}`, 'error');
                    }
                });
                
                // ê¸°ë³¸ ë©”ì‹œì§€ ì²˜ë¦¬ (fallback)
                eventSource.onmessage = function(event) {
                    log(`ê¸°ë³¸ SSE ë©”ì‹œì§€: ${event.data}`, 'info');
                };
                
                eventSource.onerror = function(event) {
                    isConnected = false;
                    updateSSEStatus(false);
                    log('SSE ì—°ê²° ì˜¤ë¥˜', 'error');
                };
                
            } catch (error) {
                log(`SSE ì—°ê²° ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }

        // SSE ì—°ê²° ëŠê¸°
        function disconnectSSE() {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }
            isConnected = false;
            updateSSEStatus(false);
            log('SSE ì—°ê²° ëŠê¹€', 'info');
        }

        // SSE ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateSSEStatus(connected) {
            const indicator = document.getElementById('sseIndicator');
            const statusText = document.getElementById('sseStatusText');
            
            if (connected) {
                indicator.className = 'status-indicator connected';
                statusText.textContent = 'ì—°ê²°ë¨';
            } else {
                indicator.className = 'status-indicator disconnected';
                statusText.textContent = 'ì—°ê²° ëŠê¹€';
            }
        }

        // ë©”ì‹œì§€ ì „ì†¡
        async function sendMessage() {
            if (!currentUserId || !currentRoomId) {
                log('ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨: ë¡œê·¸ì¸ ë˜ëŠ” ì±„íŒ…ë°© ì…ì¥ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'error');
                return;
            }
            
            const messageInput = document.getElementById('messageInput');
            const content = messageInput.value.trim();
            
            if (!content) return;

            try {
                // ì‚¬ìš©ì ë©”ì‹œì§€ í‘œì‹œ
                addMessageToChat(content, 'user');
                messageInput.value = '';
                
                // ì‘ë‹µ ìƒíƒœ ì´ˆê¸°í™” ë° ë¡œë”© í‘œì‹œ
                resetPendingResponses();
                showLoadingMessage();
                
                const response = await fetch(`/api/chat/chatrooms/${currentRoomId}/messages?userId=${currentUserId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        content: content,
                        senderType: 'user',
                        contentType: 'text'
                    })
                });

                if (response.ok) {
                    const message = await response.json();
                    log(`ë©”ì‹œì§€ ì „ì†¡ ì„±ê³µ: ${content}`, 'success');
                } else {
                    log(`ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`ë©”ì‹œì§€ ì „ì†¡ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }

        // ì±„íŒ…ì— ë©”ì‹œì§€ ì¶”ê°€
        function addMessageToChat(content, type, isChunk = false) {
            const chatMessages = document.getElementById('chatMessages');
            
            if (isChunk && type === 'bot') {
                // ì²­í¬ ë©”ì‹œì§€ì¸ ê²½ìš° ê¸°ì¡´ ë´‡ ë©”ì‹œì§€ì— ì¶”ê°€
                let lastMessage = chatMessages.lastElementChild;
                if (lastMessage && lastMessage.classList.contains('message') && lastMessage.classList.contains('bot')) {
                    lastMessage.textContent += content;
                } else {
                    // ìƒˆë¡œìš´ ë´‡ ë©”ì‹œì§€ ìƒì„±
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `message ${type}`;
                    messageDiv.textContent = content;
                    chatMessages.appendChild(messageDiv);
                }
            } else {
                // ì¼ë°˜ ë©”ì‹œì§€
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
                messageDiv.textContent = content;
            chatMessages.appendChild(messageDiv);
            }
            
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // ë©”ì‹œì§€ ë¡œë“œ
        async function loadMessages() {
            if (!currentRoomId) return;

            try {
                const response = await fetch(`/api/chat/chatrooms/${currentRoomId}/messages?userId=${currentUserId}`);
                if (response.ok) {
                    const data = await response.json();
                    const messages = data.content || [];
                    
                    const chatMessages = document.getElementById('chatMessages');
                    chatMessages.innerHTML = '';
                    
                    messages.forEach(msg => {
                        addMessageToChat(msg.content, msg.senderType);
                    });
                    
                    log(`ë©”ì‹œì§€ ë¡œë“œ: ${messages.length}ê°œ`, 'success');
                }
            } catch (error) {
                log(`ë©”ì‹œì§€ ë¡œë“œ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }

        // í‚¤ë³´ë“œ ì´ë²¤íŠ¸ ì²˜ë¦¬
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // ì±—ë´‡ í”„ë¡¬í”„íŠ¸ ì¡°íšŒ (ê°œì„ )
        async function loadChatbotPrompt() {
            if (!currentChatbotId) {
                showStatus('promptDisplay', 'ì±„íŒ…ë°©ì— ì…ì¥í•´ì£¼ì„¸ìš”.', 'error');
                document.getElementById('basePromptText').value = '';
                return;
            }
            
            try {
                const agentType = document.getElementById('agentType').value;
                
                // Conversationê³¼ Intimacyë§Œ Dynamic Directives í‘œì‹œ
                const showDynamic = (agentType === 'conversation' || agentType === 'intimacy');
                document.getElementById('dynamicDirectivesSection').style.display = showDynamic ? 'block' : 'none';
                document.getElementById('fullPromptSection').style.display = showDynamic ? 'block' : 'none';
                
                let url = `/api/chat/chatbots/prompt/full?chatbotId=${currentChatbotId}&agentType=${agentType}`;
                if (currentRoomId) {
                    url += `&chatroomId=${currentRoomId}`;
                }
                
                const response = await fetch(url);
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.type === 'full') {
                        // ì „ì²´ í”„ë¡¬í”„íŠ¸ (Base + Dynamic)
                        document.getElementById('basePromptText').value = data.basePrompt || '';
                        
                        // Dynamic Directives ê³„ì‚° (fullPrompt - basePrompt)
                        const dynamicPart = data.fullPrompt.replace(data.basePrompt, '').trim();
                        document.getElementById('dynamicDirectivesText').value = dynamicPart || '(Dynamic Directives ì—†ìŒ)';
                        document.getElementById('fullPromptText').value = data.fullPrompt || '';
                        
                        showStatus('promptDisplay', 
                            `âœ… ${data.message}\nğŸ’¡ Base Promptë§Œ ìˆ˜ì • ê°€ëŠ¥í•˜ë©°, Dynamic DirectivesëŠ” ìë™ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤.`, 
                            'success');
                    } else {
                        // Baseë§Œ
                        document.getElementById('basePromptText').value = data.prompt || '';
                        document.getElementById('dynamicDirectivesText').value = '';
                        document.getElementById('fullPromptText').value = '';
                        showStatus('promptDisplay', data.message, 'info');
                    }
                    
                    log(`ì±—ë´‡ í”„ë¡¬í”„íŠ¸ ì¡°íšŒ: ${agentType}`, 'success');
                } else {
                    showStatus('promptDisplay', 'í”„ë¡¬í”„íŠ¸ ì¡°íšŒ ì‹¤íŒ¨', 'error');
                    document.getElementById('basePromptText').value = '';
                }
            } catch (error) {
                showStatus('promptDisplay', 'í”„ë¡¬í”„íŠ¸ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ ë°œìƒ', 'error');
                log(`í”„ë¡¬í”„íŠ¸ ì¡°íšŒ ì˜¤ë¥˜: ${error.message}`, 'error');
                document.getElementById('basePromptText').value = '';
            }
        }

        // ì±—ë´‡ í”„ë¡¬í”„íŠ¸ ìˆ˜ì •
        async function updateChatbotPrompt() {
            if (!currentChatbotId) {
                showStatus('promptDisplay', 'ì±„íŒ…ë°©ì— ì…ì¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            const newPrompt = document.getElementById('basePromptText').value.trim();
            if (!newPrompt) {
                showStatus('promptDisplay', 'Base Promptë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            try {
                const agentType = document.getElementById('agentType').value;
                const response = await fetch('/api/chat/chatbots/prompt', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        chatbotId: currentChatbotId,
                        agentType: agentType,
                        systemPrompt: newPrompt
                    })
                });

                if (response.ok) {
                    showStatus('promptDisplay', 'âœ… Base Prompt ìˆ˜ì • ì„±ê³µ!\nğŸ”„ ë‹¤ìŒ ë©”ì‹œì§€ë¶€í„° ìƒˆ í”„ë¡¬í”„íŠ¸ê°€ ì ìš©ë©ë‹ˆë‹¤.', 'success');
                    log(`ì±—ë´‡ í”„ë¡¬í”„íŠ¸ ìˆ˜ì •: ${agentType}`, 'success');
                    
                    // ìˆ˜ì • í›„ ìë™ ì¬ì¡°íšŒ
                    setTimeout(() => loadChatbotPrompt(), 500);
                } else {
                    showStatus('promptDisplay', 'í”„ë¡¬í”„íŠ¸ ìˆ˜ì • ì‹¤íŒ¨', 'error');
                }
            } catch (error) {
                showStatus('promptDisplay', 'í”„ë¡¬í”„íŠ¸ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ ë°œìƒ', 'error');
                log(`í”„ë¡¬í”„íŠ¸ ìˆ˜ì • ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }

        // ì±—ë´‡ í”„ë¡¬í”„íŠ¸ ë¦¬ì…‹
        async function resetChatbotPrompt() {
            if (!currentChatbotId) {
                showStatus('promptDisplay', 'ì±„íŒ…ë°©ì— ì…ì¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            if (!confirm('í”„ë¡¬í”„íŠ¸ë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ë¦¬ì…‹í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }

            try {
                const agentType = document.getElementById('agentType').value;
                const response = await fetch(`/api/chat/chatbots/reset?chatbotId=${currentChatbotId}&agentType=${agentType}`, {
                    method: 'POST'
                });

                if (response.ok) {
                    showStatus('promptDisplay', 'í”„ë¡¬í”„íŠ¸ ë¦¬ì…‹ ì„±ê³µ', 'success');
                    log(`ì±—ë´‡ í”„ë¡¬í”„íŠ¸ ë¦¬ì…‹: ${agentType}`, 'success');
                    // ë¦¬ì…‹ í›„ ìë™ìœ¼ë¡œ ì¡°íšŒ
                    await loadChatbotPrompt();
                } else {
                    showStatus('promptDisplay', 'í”„ë¡¬í”„íŠ¸ ë¦¬ì…‹ ì‹¤íŒ¨', 'error');
                }
            } catch (error) {
                showStatus('promptDisplay', 'í”„ë¡¬í”„íŠ¸ ë¦¬ì…‹ ì¤‘ ì˜¤ë¥˜ ë°œìƒ', 'error');
                log(`í”„ë¡¬í”„íŠ¸ ë¦¬ì…‹ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }

        // ì±„íŒ…ë°© ë‚˜ê°€ê¸°
        async function leaveChatRoom() {
            if (!currentRoomId) {
                log('ì±„íŒ…ë°©ì— ì…ì¥í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', 'error');
                return;
            }
            
            if (!confirm('ì±„íŒ…ë°©ì„ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/chat/chatrooms/${currentRoomId}/leave?userId=${currentUserId}`, {
                    method: 'POST'
                });
                
                if (response.ok || response.status === 204) {
                    log('ì±„íŒ…ë°© ë‚˜ê°€ê¸° ì„±ê³µ', 'success');
                    
                    // SSE ì—°ê²° í•´ì œ
                    if (eventSource) {
                        disconnectSSE();
                    }
                    
                    // UI ì´ˆê¸°í™”
                    currentRoomId = null;
                    currentChatbotId = null;
                    document.getElementById('chatMessages').innerHTML = '<div class="message system">ì±„íŒ…ë°©ì— ì…ì¥í•˜ë©´ ì—¬ê¸°ì— ë©”ì‹œì§€ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>';
                    document.getElementById('chatbotManagement').classList.add('hidden');
                    document.getElementById('chatRoomInfo').classList.add('hidden');
                    document.getElementById('currentRoomIdDisplay').textContent = '-';
                    document.getElementById('promptText').value = '';
                    
                    // ì±„íŒ…ë°© ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    loadChatRooms();
                } else {
                    log(`ì±„íŒ…ë°© ë‚˜ê°€ê¸° ì‹¤íŒ¨: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`ì±„íŒ…ë°© ë‚˜ê°€ê¸° ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }

        // ì¹œë°€ë„ ë ˆë²¨ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        async function updateIntimacyLevel() {
            if (!currentRoomId || !currentUserId) {
                log('ì¹œë°€ë„ ë³€ê²½ ì‹¤íŒ¨: ì±„íŒ…ë°©ì— ì…ì¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            
            const newLevel = parseInt(document.getElementById('currentIntimacyLevel').value);
            
            try {
                const response = await fetch(`/api/chat/chatrooms/${currentRoomId}/intimacy`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ intimacyLevel: newLevel })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    log(`ì¹œë°€ë„ ë³€ê²½ ì„±ê³µ: ë ˆë²¨ ${newLevel}`, 'success');
                    addMessageToChat(`ğŸ“Š ì¹œë°€ë„ê°€ ë ˆë²¨ ${newLevel}ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'system');
                    
                    // í”„ë¡¬í”„íŠ¸ ìë™ ì¬ì¡°íšŒ (Dynamic Directives ë°˜ì˜)
                    if (currentChatbotId) {
                        await loadChatbotPrompt();
                    }
                } else {
                    log(`ì¹œë°€ë„ ë³€ê²½ ì‹¤íŒ¨: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`ì¹œë°€ë„ ë³€ê²½ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }

        // Directives ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadDirectives() {
            let chatbotId = document.getElementById('directiveChatbotId').value.trim();
            
            // ì±—ë´‡ IDê°€ ë¹„ì–´ìˆìœ¼ë©´ í˜„ì¬ ì±„íŒ…ë°©ì˜ ì±—ë´‡ ì‚¬ìš©
            if (!chatbotId && currentChatbotId) {
                chatbotId = currentChatbotId;
                document.getElementById('directiveChatbotId').value = chatbotId;
            }
            
            if (!chatbotId) {
                showStatus('directiveStatus', 'ì±—ë´‡ IDë¥¼ ì…ë ¥í•˜ê±°ë‚˜ ì±„íŒ…ë°©ì„ ì„ íƒí•´ì£¼ì„¸ìš”', 'error');
                return;
            }
            
            try {
                log(`Directives ë¡œë“œ ì‹œë„: ${chatbotId}`);
                const response = await fetch(`/api/chat/chatbots/${chatbotId}/directives`);
                
                if (response.ok) {
                    const data = await response.json();
                    const directives = data.directives;
                    
                    // Concept
                    if (directives.concept) {
                        document.getElementById('conceptEnabled').checked = directives.concept.enabled !== false;
                        document.getElementById('conceptCustom').value = directives.concept.custom || '';
                    }
                    
                    // Intimacy
                    if (directives.intimacy) {
                        document.getElementById('intimacyEnabled').checked = directives.intimacy.enabled !== false;
                        document.getElementById('intimacyCustom').value = directives.intimacy.custom || '';
                    }
                    
                    // Language
                    if (directives.language) {
                        document.getElementById('languageEnabled').checked = directives.language.enabled !== false;
                        document.getElementById('defaultLanguage').value = directives.language.default || 'ko';
                        document.getElementById('allowUserOverride').checked = directives.language.allowUserOverride !== false;
                    }
                    
                    showStatus('directiveStatus', 'Directives ë¡œë“œ ì™„ë£Œ', 'success');
                    log('Directives ë¡œë“œ ì„±ê³µ', 'success');
                } else {
                    showStatus('directiveStatus', 'Directives ë¡œë“œ ì‹¤íŒ¨', 'error');
                    log(`Directives ë¡œë“œ ì‹¤íŒ¨: ${response.status}`, 'error');
                }
            } catch (error) {
                showStatus('directiveStatus', 'ì˜¤ë¥˜ ë°œìƒ', 'error');
                log(`Directives ë¡œë“œ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }

        // Directives ì—…ë°ì´íŠ¸
        async function updateDirectives() {
            const chatbotId = document.getElementById('directiveChatbotId').value.trim();
            
            if (!chatbotId) {
                showStatus('directiveStatus', 'ì±—ë´‡ IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error');
                return;
            }
            
            const request = {
                concept: {
                    enabled: document.getElementById('conceptEnabled').checked,
                    custom: document.getElementById('conceptCustom').value.trim() || null
                },
                intimacy: {
                    enabled: document.getElementById('intimacyEnabled').checked,
                    custom: document.getElementById('intimacyCustom').value.trim() || null
                },
                language: {
                    enabled: document.getElementById('languageEnabled').checked,
                    defaultLang: document.getElementById('defaultLanguage').value,
                    allowUserOverride: document.getElementById('allowUserOverride').checked
                }
            };
            
            try {
                log(`Directives ì—…ë°ì´íŠ¸ ì‹œë„: ${chatbotId}`, 'info');
                const response = await fetch(`/api/chat/chatbots/${chatbotId}/directives`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(request)
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showStatus('directiveStatus', 'Directives ì—…ë°ì´íŠ¸ ì„±ê³µ!', 'success');
                    log('Directives ì—…ë°ì´íŠ¸ ì™„ë£Œ', 'success');
                    log(`ì„¤ì • ë‚´ìš©: ${JSON.stringify(request, null, 2)}`, 'info');
                } else {
                    showStatus('directiveStatus', 'Directives ì—…ë°ì´íŠ¸ ì‹¤íŒ¨', 'error');
                    log(`Directives ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ${response.status}`, 'error');
                }
            } catch (error) {
                showStatus('directiveStatus', 'ì˜¤ë¥˜ ë°œìƒ', 'error');
                log(`Directives ì—…ë°ì´íŠ¸ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            log('í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ', 'info');
        });
    </script>
</body>
</html>
